[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.420215",
  "module": "Electro Zone",
  "name": "Sales Order - Storekeeper Actions",
  "script": "frappe.ui.form.on('Sales Order', {\r\n    refresh: function(frm) {\r\n        // Only show buttons if SO is in Draft and Pending Review\r\n        if (frm.doc.docstatus === 0 && frm.doc.status === \"Pending Review\") {\r\n            // Check if user has permission\r\n            if (frappe.user.has_role(['Stock User', 'Stock Manager'])) {\r\n                \r\n                // Add Fulfill Order button\r\n                frm.add_custom_button(__('Fulfill Order'), function() {\r\n                    frappe.confirm(\r\n                        'Are you sure you want to fulfill this order?<br><br>' +\r\n                        '<b>This will:</b><br>' +\r\n                        '1. Submit the Sales Order<br>' +\r\n                        '2. Move stock to Hold warehouse<br>' +\r\n                        '3. Create a Delivery Note (Draft)',\r\n                        function() {\r\n                            // Call API to fulfill order\r\n                            frappe.call({\r\n                                method: 'fulfill_sales_order',\r\n                                args: {\r\n                                    sales_order: frm.doc.name\r\n                                },\r\n                                callback: function(r) {\r\n                                    if (r.message && r.message.success) {\r\n                                        frappe.msgprint({\r\n                                            title: __('Order Fulfilled'),\r\n                                            indicator: 'green',\r\n                                            message: r.message.message\r\n                                        });\r\n                                        frm.reload_doc();\r\n                                        \r\n                                        // Open Delivery Note\r\n                                        if (r.message.delivery_note) {\r\n                                            frappe.set_route('Form', 'Delivery Note', r.message.delivery_note);\r\n                                        }\r\n                                    }\r\n                                }\r\n                            });\r\n                        }\r\n                    );\r\n                }, __('Actions')).css({'background-color': '#28a745', 'color': 'white'});\r\n                \r\n                // Add Cancel Order button\r\n                frm.add_custom_button(__('Cancel Order'), function() {\r\n                    // Prompt for reason\r\n                    frappe.prompt([\r\n                        {\r\n                            fieldname: 'reason',\r\n                            fieldtype: 'Small Text',\r\n                            label: 'Cancellation Reason',\r\n                            reqd: 1\r\n                        }\r\n                    ], function(values) {\r\n                        frappe.confirm(\r\n                            'Are you sure you want to cancel this order?<br><br>' +\r\n                            '<b>Reason:</b> ' + values.reason,\r\n                            function() {\r\n                                // Call API to cancel order\r\n                                frappe.call({\r\n                                    method: 'cancel_sales_order',\r\n                                    args: {\r\n                                        sales_order: frm.doc.name,\r\n                                        reason: values.reason\r\n                                    },\r\n                                    callback: function(r) {\r\n                                        if (r.message && r.message.success) {\r\n                                            frappe.msgprint({\r\n                                                title: __('Order Cancelled'),\r\n                                                indicator: 'red',\r\n                                                message: r.message.message\r\n                                            });\r\n                                            // Go back to list\r\n                                            frappe.set_route('List', 'Sales Order');\r\n                                        }\r\n                                    }\r\n                                });\r\n                            }\r\n                        );\r\n                    }, __('Cancel Order'), __('Cancel'));\r\n                }, __('Actions')).css({'background-color': '#dc3545', 'color': 'white'});\r\n                \r\n                // Add Keep on Hold button\r\n                frm.add_custom_button(__('Keep on Hold'), function() {\r\n                    frappe.msgprint({\r\n                        title: __('Order Kept on Hold'),\r\n                        indicator: 'blue',\r\n                        message: 'Order will remain in Pending Review status.<br>You can process it later.'\r\n                    });\r\n                }, __('Actions')).css({'background-color': '#ffc107', 'color': 'black'});\r\n            }\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.429598",
  "module": "Electro Zone",
  "name": "PO - Stock User Limited View",
  "script": "frappe.ui.form.on('Purchase Order', {\r\n  refresh(frm) {\r\n    // Only affect Stock User (don't touch System Manager)\r\n    const isStockUserOnly =\r\n      frappe.user.has_role('Stock User') && !frappe.user.has_role('System Manager');\r\n    \r\n    if (!isStockUserOnly) return;\r\n\r\n    // -------------------- Add Purchase Receipt Button FIRST --------------------\r\n    // Add button immediately for submitted documents\r\n    if (frm.doc.docstatus === 1) {\r\n      // Clear and re-add to ensure it appears\r\n      frm.page.clear_inner_toolbar();\r\n      \r\n      frm.add_custom_button(__('Make Purchase Receipt'), () => {\r\n        frappe.model.open_mapped_doc({\r\n          method: \"erpnext.buying.doctype.purchase_order.purchase_order.make_purchase_receipt\",\r\n          frm: frm\r\n        });\r\n      }).addClass('btn-primary');\r\n    }\r\n\r\n    // -------------------- Hide Tabs --------------------\r\n    ['more_info', 'connections'].forEach(tab => {\r\n      if (frm.fields_dict[tab]) {\r\n        frm.set_df_property(tab, 'hidden', 1);\r\n      }\r\n    });\r\n\r\n    // -------------------- Hide Status Indicators --------------------\r\n    const statusFields = [\r\n      'status',\r\n      'per_billed',\r\n      'per_received'\r\n    ];\r\n    statusFields.forEach(field => {\r\n      frm.set_df_property(field, 'hidden', 1);\r\n    });\r\n\r\n    // -------------------- Hide Parent Money Fields --------------------\r\n    const parentMoneyFields = [\r\n      // Currency & Conversion\r\n      'currency', 'conversion_rate', 'price_list_currency', 'plc_conversion_rate',\r\n      // Totals\r\n      'base_total', 'total', 'base_net_total', 'net_total',\r\n      'base_grand_total', 'grand_total',\r\n      // Rounding & In Words\r\n      'rounding_adjustment', 'base_rounding_adjustment',\r\n      'rounded_total', 'base_rounded_total',\r\n      'in_words', 'base_in_words',\r\n      'disable_rounded_total',\r\n      // Taxes\r\n      'taxes', 'taxes_and_charges', 'total_taxes_and_charges', 'base_total_taxes_and_charges',\r\n      'tax_category',\r\n      // Discounts\r\n      'apply_discount_on', 'additional_discount_percentage',\r\n      'discount_amount', 'additional_discount_amount',\r\n      'base_discount_amount', 'base_additional_discount_amount',\r\n      // Advances / Payments / Pricing\r\n      'advance_paid', 'payment_terms_template', 'payment_schedule',\r\n      'ignore_pricing_rule', 'pricing_rules'\r\n    ];\r\n    \r\n    parentMoneyFields.forEach(field => {\r\n      frm.set_df_property(field, 'hidden', 1);\r\n    });\r\n\r\n    // -------------------- Hide Items Grid Money Fields --------------------\r\n    const childMoneyFields = [\r\n      'rate', 'amount', 'base_rate', 'base_amount',\r\n      'net_rate', 'net_amount', 'price_list_rate', 'valuation_rate',\r\n      'discount_percentage', 'discount_amount',\r\n      'item_tax_template', 'item_tax_rate',\r\n      'gross_profit', 'margin_rate_or_amount', 'margin_type',\r\n      'pricing_rules'\r\n    ];\r\n\r\n    if (frm.fields_dict['items']?.grid) {\r\n      const grid = frm.fields_dict['items'].grid;\r\n      \r\n      childMoneyFields.forEach(fieldname => {\r\n        grid.update_docfield_property(fieldname, 'hidden', 1);\r\n        grid.update_docfield_property(fieldname, 'read_only', 1);\r\n      });\r\n      \r\n      grid.refresh();\r\n    }\r\n\r\n\r\n\r\n    // -------------------- Hide Dashboard Indicators --------------------\r\n    // Hide billing and receiving percentage from dashboard\r\n    if (frm.dashboard?.stats_area) {\r\n      setTimeout(() => {\r\n        frm.dashboard.stats_area.find('.form-stats').hide();\r\n      }, 200);\r\n    }\r\n  },\r\n\r\n  onload(frm) {\r\n    // Additional hiding for Stock User on form load\r\n    const isStockUserOnly =\r\n      frappe.user.has_role('Stock User') && !frappe.user.has_role('System Manager');\r\n    \r\n    if (isStockUserOnly) {\r\n      // Hide status indicators in the form layout\r\n      ['status', 'per_billed', 'per_received'].forEach(field => {\r\n        frm.set_df_property(field, 'hidden', 1);\r\n      });\r\n    }\r\n  }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.442781",
  "module": "Electro Zone",
  "name": "Purchase Order - Filter Items by Supplier with Quick Add",
  "script": "// ====================================================================================\r\n// PURCHASE ORDER - ITEM GRID LOCKDOWN & CUSTOM BUTTONS (CLIENT SCRIPT)\r\n// ====================================================================================\r\n// Purpose: Lock item grid when PO is approved, hide buttons, add \"Get Items by Supplier\"\r\n// Apply To: Purchase Order\r\n// ====================================================================================\r\n\r\nfrappe.ui.form.on(\"Purchase Order\", {\r\n  before_load: function (frm) {\r\n    // Inject CSS to hide buttons globally (before form loads)\r\n    if (!$(\"#hide-po-buttons\").length) {\r\n      $(\r\n        '<style id=\"hide-po-buttons\">\\\r\n        .inner-group-button[data-label=\"Status\"] { display: none !important; }\\\r\n        .inner-group-button[data-label=\"Tools\"] { display: none !important; }\\\r\n        button[data-label=\"Update%20Items\"] { display: none !important; }\\\r\n        button[data-label=\"Get%20Items%20From\"] { display: none !important; }\\\r\n        .btn-default.ellipsis[data-toggle=\"dropdown\"]:contains(\"Get Items From\") { display: none !important; }\\\r\n      </style>'\r\n      ).appendTo(\"head\");\r\n    }\r\n  },\r\n\r\n  setup: function (frm) {\r\n    // Clear menu to prevent button creation\r\n    frm.page.clear_menu();\r\n  },\r\n\r\n  refresh: function (frm) {\r\n    // Extra safety - remove buttons if they appear\r\n    frm.remove_custom_button(\"Get Items From\");\r\n    $('.inner-group-button[data-label=\"Status\"]').remove();\r\n    $('.inner-group-button[data-label=\"Tools\"]').remove();\r\n    $('button[data-label=\"Update%20Items\"]').remove();\r\n    $('button[data-label=\"Get%20Items%20From\"]').remove();\r\n    $('.btn-default.ellipsis:contains(\"Get Items From\")').parent().remove();\r\n\r\n    // COMPLETE ITEM GRID LOCKDOWN - ONLY when workflow_state is \"Approved\"\r\n    // Allow editing when: workflow_state is NOT \"Approved\" (Draft, Pending, etc.)\r\n    // Block editing when: workflow_state === \"Approved\"\r\n    if (frm.doc.workflow_state === \"Approved\") {\r\n      // Make items table completely read-only\r\n      frm.fields_dict.items.grid.cannot_add_rows = true;\r\n      frm.fields_dict.items.grid.wrapper.find(\".grid-add-row\").remove();\r\n      frm.fields_dict.items.grid.wrapper.find(\".grid-remove-rows\").remove();\r\n\r\n      // Disable all item row controls (delete buttons)\r\n      frm.doc.items.forEach((item, idx) => {\r\n        frm.fields_dict.items.grid.grid_rows[idx].wrapper\r\n          .find(\".grid-delete-row\")\r\n          .remove();\r\n      });\r\n\r\n      // Make entire grid read-only (no field editing)\r\n      frm.set_df_property(\"items\", \"read_only\", 1);\r\n\r\n      // Lock specific fields in items table (including item_code)\r\n      frm.fields_dict.items.grid.docfields.forEach(function (df) {\r\n        if (\r\n          df.fieldname === \"item_code\" ||\r\n          df.fieldname === \"item_name\" ||\r\n          df.fieldname === \"qty\" ||\r\n          df.fieldname === \"rate\" ||\r\n          df.fieldname === \"amount\"\r\n        ) {\r\n          df.read_only = 1;\r\n        }\r\n      });\r\n\r\n      // Disable all input fields in the grid (but KEEP download button functional)\r\n      frm.fields_dict.items.grid.wrapper\r\n        .find(\"input, select, textarea\")\r\n        .prop(\"disabled\", true);\r\n\r\n      // Disable grid action buttons (except download)\r\n      frm.fields_dict.items.grid.wrapper\r\n        .find(\"button\")\r\n        .not('.grid-download, .btn-open-row, [data-action=\"download\"]')\r\n        .prop(\"disabled\", true);\r\n\r\n      // Block pointer events on inputs only (no grayed out effect)\r\n      frm.fields_dict.items.grid.wrapper\r\n        .find(\"input, select, textarea\")\r\n        .css(\"pointer-events\", \"none\");\r\n    } else {\r\n      // ALLOW editing when NOT Approved (Draft, Pending, etc.)\r\n      // Explicitly enable adding/removing rows\r\n      frm.fields_dict.items.grid.cannot_add_rows = false;\r\n      frm.set_df_property(\"items\", \"read_only\", 0);\r\n\r\n      // Refresh grid to restore all buttons (Add Row, Add Multiple, etc.)\r\n      frm.fields_dict.items.grid.refresh();\r\n\r\n      // Enable all input fields\r\n      frm.fields_dict.items.grid.wrapper\r\n        .find(\"input, select, textarea, button\")\r\n        .prop(\"disabled\", false)\r\n        .css(\"pointer-events\", \"auto\");\r\n\r\n      // Ensure grid buttons are visible\r\n      frm.fields_dict.items.grid.wrapper.find(\".grid-add-row\").show();\r\n      frm.fields_dict.items.grid.wrapper.find(\".grid-buttons\").show();\r\n    }\r\n\r\n    // Apply filter when form loads\r\n    if (frm.doc.supplier) {\r\n      set_item_query_and_disable_creation(frm);\r\n\r\n      // Add custom button ONLY when workflow allows editing\r\n      // Show button when: workflow_state is NOT \"Approved\"\r\n      // Hide button when: workflow_state === \"Approved\"\r\n      if (frm.doc.workflow_state !== \"Approved\") {\r\n        let btn = frm.add_custom_button(\r\n          __(\"Get Items by Supplier\"),\r\n          function () {\r\n            show_supplier_items_dialog(frm);\r\n          }\r\n        );\r\n\r\n        // Apply base styling\r\n        btn.css({\r\n          \"background-color\": \"#216DFF\",\r\n          color: \"white\",\r\n          border: \"none\",\r\n        });\r\n\r\n        // Add hover effect\r\n        btn.hover(\r\n          function () {\r\n            $(this).css(\"background-color\", \"#5A8FFF\"); // Softer/lighter on hover\r\n          },\r\n          function () {\r\n            $(this).css(\"background-color\", \"#216DFF\"); // Original color\r\n          }\r\n        );\r\n\r\n        // Add click/active effect\r\n        btn.on(\"mousedown\", function () {\r\n          $(this).css(\"background-color\", \"#4A7FFF\"); // Medium shade when clicking\r\n        });\r\n\r\n        btn.on(\"mouseup\", function () {\r\n          $(this).css(\"background-color\", \"#5A8FFF\"); // Return to hover color\r\n        });\r\n      }\r\n    }\r\n  },\r\n\r\n  supplier: function (frm) {\r\n    // Apply filter when supplier changes\r\n    if (frm.doc.supplier) {\r\n      set_item_query_and_disable_creation(frm);\r\n\r\n      // Clear existing items if supplier changes\r\n      if (frm.doc.items && frm.doc.items.length > 0) {\r\n        frappe.confirm(\r\n          \"Changing supplier will clear all items. Do you want to continue?\",\r\n          function () {\r\n            // User clicked Yes\r\n            frm.clear_table(\"items\");\r\n            frm.refresh_field(\"items\");\r\n          },\r\n          function () {\r\n            // User clicked No - revert supplier change\r\n            frm.set_value(\"supplier\", frm.doc.__previous_supplier);\r\n          }\r\n        );\r\n      }\r\n\r\n      // Store current supplier for comparison\r\n      frm.doc.__previous_supplier = frm.doc.supplier;\r\n    } else {\r\n      // If supplier is cleared, remove filter\r\n      frm.fields_dict[\"items\"].grid.get_field(\"item_code\").get_query = null;\r\n    }\r\n  },\r\n});\r\n\r\nfrappe.ui.form.on(\"Purchase Order Item\", {\r\n  before_items_add: function (frm, cdt, cdn) {\r\n    // Block adding items ONLY when workflow_state = \"Approved\"\r\n    if (frm.doc.workflow_state === \"Approved\") {\r\n      frappe.msgprint({\r\n        title: __(\"Action Blocked\"),\r\n        message: __(\r\n          \"Cannot add items to an approved Purchase Order. Workflow State: Approved\"\r\n        ),\r\n        indicator: \"red\",\r\n      });\r\n      frappe.validated = false;\r\n      return false;\r\n    }\r\n  },\r\n\r\n  before_items_remove: function (frm, cdt, cdn) {\r\n    // Block removing items ONLY when workflow_state = \"Approved\"\r\n    if (frm.doc.workflow_state === \"Approved\") {\r\n      frappe.msgprint({\r\n        title: __(\"Action Blocked\"),\r\n        message: __(\r\n          \"Cannot remove items from an approved Purchase Order. Workflow State: Approved\"\r\n        ),\r\n        indicator: \"red\",\r\n      });\r\n      frappe.validated = false;\r\n      return false;\r\n    }\r\n  },\r\n\r\n  items_add: function (frm, cdt, cdn) {\r\n    // Disable item creation when adding new row\r\n    if (frm.doc.supplier) {\r\n      set_item_query_and_disable_creation(frm);\r\n    }\r\n  },\r\n});\r\n\r\nfunction set_item_query_and_disable_creation(frm) {\r\n  // Filter items to show only those with matching custom_primary_supplier\r\n  // AND disable the \"Create\" option completely\r\n  frm.set_query(\"item_code\", \"items\", function () {\r\n    return {\r\n      filters: {\r\n        custom_primary_supplier: frm.doc.supplier,\r\n        is_purchase_item: 1,\r\n        disabled: 0,\r\n      },\r\n    };\r\n  });\r\n\r\n  // Disable the \"Create\" option in item dropdown by setting only_select\r\n  if (frm.fields_dict[\"items\"] && frm.fields_dict[\"items\"].grid) {\r\n    let item_field = frm.fields_dict[\"items\"].grid.get_field(\"item_code\");\r\n    if (item_field) {\r\n      item_field.get_query = function () {\r\n        return {\r\n          filters: {\r\n            custom_primary_supplier: frm.doc.supplier,\r\n            is_purchase_item: 1,\r\n            disabled: 0,\r\n          },\r\n        };\r\n      };\r\n      // This prevents \"Create\" option from showing\r\n      item_field.only_select = true;\r\n    }\r\n  }\r\n}\r\n\r\nfunction filter_items_by_group(dialog, selected_group, all_items) {\r\n  // Filter items based on selected group\r\n  let filtered_items = all_items;\r\n  if (selected_group !== \"All Groups\") {\r\n    filtered_items = all_items.filter(\r\n      (item) => item.item_group === selected_group\r\n    );\r\n  }\r\n\r\n  // Re-render the table with filtered items\r\n  render_items_table(dialog, filtered_items);\r\n}\r\n\r\nfunction render_items_table(dialog, items) {\r\n  // Build HTML table with checkboxes - Enhanced UI/UX version\r\n  let html = `\r\n        <style>\r\n        /* ========================================\r\n           ENHANCED SUPPLIER ITEMS TABLE STYLING\r\n           ======================================== */\r\n\r\n        /* Main table container with card-like appearance */\r\n        .supplier-items-container {\r\n            background: #ffffff;\r\n            border-radius: 8px;\r\n            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);\r\n            overflow: hidden;\r\n            margin-bottom: 16px;\r\n        }\r\n\r\n        /* Scrollable wrapper */\r\n        .supplier-items-scroll {\r\n            max-height: 520px;\r\n            overflow-y: auto;\r\n            overflow-x: auto;\r\n        }\r\n\r\n        /* Custom scrollbar styling */\r\n        .supplier-items-scroll::-webkit-scrollbar {\r\n            width: 8px;\r\n            height: 8px;\r\n        }\r\n\r\n        .supplier-items-scroll::-webkit-scrollbar-track {\r\n            background: #f1f1f1;\r\n            border-radius: 4px;\r\n        }\r\n\r\n        .supplier-items-scroll::-webkit-scrollbar-thumb {\r\n            background: #c1c1c1;\r\n            border-radius: 4px;\r\n        }\r\n\r\n        .supplier-items-scroll::-webkit-scrollbar-thumb:hover {\r\n            background: #a8a8a8;\r\n        }\r\n\r\n        /* Table base styling */\r\n        .supplier-items-table {\r\n            width: 100%;\r\n            border-collapse: separate;\r\n            border-spacing: 0;\r\n            font-size: 13px;\r\n            margin: 0;\r\n            table-layout: fixed; /* Fixed layout for better column control */\r\n        }\r\n\r\n        /* Header styling with gradient and shadow */\r\n        .supplier-items-table thead {\r\n            background: linear-gradient(to bottom, #f8f9fc 0%, #f1f3f8 100%);\r\n            border-bottom: 2px solid #e2e8f0;\r\n        }\r\n\r\n        .supplier-items-table th {\r\n            font-weight: 600;\r\n            font-size: 12px;\r\n            text-transform: uppercase;\r\n            letter-spacing: 0.5px;\r\n            color: #4a5568;\r\n            padding: 14px 12px;\r\n            text-align: left;\r\n            position: sticky;\r\n            top: 0;\r\n            z-index: 10;\r\n            background: linear-gradient(to bottom, #f8f9fc 0%, #f1f3f8 100%);\r\n            border-bottom: 2px solid #e2e8f0;\r\n            white-space: nowrap;\r\n        }\r\n\r\n        /* Column-specific text alignment */\r\n        .supplier-items-table th.text-center,\r\n        .supplier-items-table td.text-center {\r\n            text-align: center;\r\n        }\r\n\r\n        .supplier-items-table th.text-right,\r\n        .supplier-items-table td.text-right {\r\n            text-align: right;\r\n        }\r\n\r\n        /* Checkbox column */\r\n        .supplier-items-table th:first-child,\r\n        .supplier-items-table td:first-child {\r\n            width: 50px;\r\n            text-align: center;\r\n        }\r\n\r\n        /* Body rows */\r\n        .supplier-items-table tbody tr {\r\n            border-bottom: 1px solid #e2e8f0;\r\n            transition: all 0.2s ease;\r\n        }\r\n\r\n        .supplier-items-table tbody tr:last-child {\r\n            border-bottom: none;\r\n        }\r\n\r\n        .supplier-items-table tbody tr:hover {\r\n            background-color: #f7fafc;\r\n            box-shadow: inset 0 0 0 1px #e2e8f0;\r\n            cursor: pointer;\r\n        }\r\n\r\n        /* Body cells */\r\n        .supplier-items-table td {\r\n            padding: 12px;\r\n            vertical-align: middle;\r\n            color: #2d3748;\r\n            line-height: 1.5;\r\n            word-wrap: break-word;\r\n        }\r\n\r\n        /* Checkbox styling */\r\n        .item-checkbox {\r\n            width: 18px;\r\n            height: 18px;\r\n            cursor: pointer;\r\n            accent-color: #216DFF;\r\n        }\r\n\r\n        #select-all-items {\r\n            width: 18px;\r\n            height: 18px;\r\n            cursor: pointer;\r\n            accent-color: #216DFF;\r\n        }\r\n\r\n        /* Item Code column - bold and prominent */\r\n        .item-code-cell {\r\n            font-weight: 600;\r\n            color: #1a202c;\r\n            font-size: 13px;\r\n        }\r\n\r\n        /* Model Number column - colored and styled */\r\n        .model-number-cell {\r\n            color: #e53e3e;\r\n            font-weight: 600;\r\n            font-size: 13px;\r\n            letter-spacing: 0.3px;\r\n        }\r\n\r\n        /* Item Name column */\r\n        .item-name-cell {\r\n            color: #2d3748;\r\n            font-size: 13px;\r\n            overflow: hidden;\r\n            text-overflow: ellipsis;\r\n        }\r\n\r\n        /* UOM column - badge style */\r\n        .uom-badge {\r\n            display: inline-block;\r\n            padding: 4px 10px;\r\n            background: #edf2f7;\r\n            color: #4a5568;\r\n            border-radius: 4px;\r\n            font-size: 11px;\r\n            font-weight: 600;\r\n            text-transform: uppercase;\r\n        }\r\n\r\n        /* Rate column - prominent pricing */\r\n        .rate-cell {\r\n            font-weight: 700;\r\n            color: #2d3748;\r\n            font-size: 14px;\r\n            white-space: nowrap;\r\n        }\r\n\r\n        /* Description column - wrapped text with proper styling */\r\n        .description-cell {\r\n            font-size: 11px;\r\n            color: #718096;\r\n            line-height: 1.6;\r\n            max-width: 350px;\r\n            word-wrap: break-word;\r\n            white-space: normal;\r\n            overflow: hidden;\r\n            display: -webkit-box;\r\n            -webkit-line-clamp: 3; /* Limit to 3 lines */\r\n            -webkit-box-orient: vertical;\r\n        }\r\n\r\n        /* Empty state styling */\r\n        .empty-state {\r\n            text-align: center;\r\n            padding: 60px 20px;\r\n            color: #a0aec0;\r\n        }\r\n\r\n        .empty-state svg {\r\n            width: 64px;\r\n            height: 64px;\r\n            margin-bottom: 16px;\r\n            opacity: 0.5;\r\n        }\r\n\r\n        .empty-state-text {\r\n            font-size: 14px;\r\n            font-weight: 500;\r\n            margin-bottom: 4px;\r\n        }\r\n\r\n        .empty-state-subtext {\r\n            font-size: 12px;\r\n            color: #cbd5e0;\r\n        }\r\n\r\n        /* Tip box at bottom */\r\n        .items-tip-box {\r\n            margin-top: 12px;\r\n            padding: 12px 16px;\r\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n            border-radius: 6px;\r\n            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.2);\r\n        }\r\n\r\n        .items-tip-box-text {\r\n            color: #ffffff;\r\n            font-size: 12px;\r\n            line-height: 1.5;\r\n            margin: 0;\r\n            display: flex;\r\n            align-items: center;\r\n            gap: 8px;\r\n        }\r\n\r\n        .items-tip-icon {\r\n            font-size: 16px;\r\n            opacity: 0.9;\r\n        }\r\n\r\n        /* Responsive design */\r\n        @media (max-width: 1200px) {\r\n            .supplier-items-table {\r\n                font-size: 12px;\r\n            }\r\n\r\n            .supplier-items-table th,\r\n            .supplier-items-table td {\r\n                padding: 10px 8px;\r\n            }\r\n        }\r\n        </style>\r\n\r\n        <div class=\"supplier-items-container\">\r\n            <div class=\"supplier-items-scroll\">\r\n                <table class=\"supplier-items-table\">\r\n                    <thead>\r\n                        <tr>\r\n                            <th class=\"text-center\">\r\n                                <input type=\"checkbox\" id=\"select-all-items\">\r\n                            </th>\r\n                            <th style=\"width: 14%;\">Item Code</th>\r\n                            <th style=\"width: 14%;\">Model Number</th>\r\n                            <th style=\"width: 18%;\">Item Name</th>\r\n                            <th class=\"text-center\" style=\"width: 8%;\">UOM</th>\r\n                            <th class=\"text-right\" style=\"width: 12%;\">Rate</th>\r\n                            <th style=\"width: 34%;\">Description</th>\r\n                        </tr>\r\n                    </thead>\r\n                    <tbody>\r\n    `;\r\n\r\n  if (items.length === 0) {\r\n    html += `\r\n            <tr>\r\n                <td colspan=\"7\" class=\"empty-state\">\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                        <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4\" />\r\n                    </svg>\r\n                    <div class=\"empty-state-text\">No items found</div>\r\n                    <div class=\"empty-state-subtext\">Try changing your filter selection</div>\r\n                </td>\r\n            </tr>\r\n        `;\r\n  } else {\r\n    items.forEach(function (item, index) {\r\n      html += `\r\n                <tr data-item-index=\"${index}\">\r\n                    <td class=\"text-center\" onclick=\"event.stopPropagation();\">\r\n                        <input type=\"checkbox\" class=\"item-checkbox\" data-item-code=\"${item.name}\">\r\n                    </td>\r\n                    <td class=\"item-code-cell\">${item.name}</td>\r\n                    <td class=\"model-number-cell\">${item.custom_item_model || \"-\"}</td>\r\n                    <td class=\"item-name-cell\" title=\"${item.item_name || \"\"}\">${\r\n        item.item_name || \"\"\r\n      }</td>\r\n                    <td class=\"text-center\">\r\n                        <span class=\"uom-badge\">${item.stock_uom || \"Nos\"}</span>\r\n                    </td>\r\n                    <td class=\"rate-cell text-right\">${frappe.format(\r\n            item.custom_repeat_final_rate_price || 0,\r\n            { fieldtype: \"Currency\" }\r\n          )}</td>\r\n                    <td class=\"description-cell\" title=\"${item.description || \"-\"}\">\r\n                        ${item.description || \"-\"}\r\n                    </td>\r\n                </tr>\r\n            `;\r\n    });\r\n  }\r\n\r\n  html += `\r\n                    </tbody>\r\n                </table>\r\n            </div>\r\n        </div>\r\n\r\n        <div class=\"items-tip-box\">\r\n            <p class=\"items-tip-box-text\">\r\n                <span class=\"items-tip-icon\">ðŸ’¡</span>\r\n                <span><strong>Tip:</strong> Click on any row to select/deselect items, or use the checkbox in the header to select all.</span>\r\n            </p>\r\n        </div>\r\n    `;\r\n\r\n  dialog.fields_dict.items_html.$wrapper.html(html);\r\n\r\n  // Add select all functionality\r\n  dialog.$wrapper.find(\"#select-all-items\").on(\"change\", function () {\r\n    dialog.$wrapper\r\n      .find(\".item-checkbox\")\r\n      .prop(\"checked\", $(this).prop(\"checked\"));\r\n  });\r\n\r\n  // Add row click functionality (checkbox toggle)\r\n  dialog.$wrapper\r\n    .find(\".supplier-items-table tbody tr\")\r\n    .on(\"click\", function (e) {\r\n      if (!$(e.target).is('input[type=\"checkbox\"]')) {\r\n        let checkbox = $(this).find(\".item-checkbox\");\r\n        checkbox.prop(\"checked\", !checkbox.prop(\"checked\"));\r\n      }\r\n    });\r\n}\r\n\r\nfunction show_supplier_items_dialog(frm) {\r\n  // Fetch items for the selected supplier\r\n  frappe.call({\r\n    method: \"frappe.client.get_list\",\r\n    args: {\r\n      doctype: \"Item\",\r\n      filters: {\r\n        custom_primary_supplier: frm.doc.supplier,\r\n        is_purchase_item: 1,\r\n        disabled: 0,\r\n      },\r\n      fields: [\r\n        \"name\",\r\n        \"item_name\",\r\n        \"item_group\",\r\n        \"custom_item_model\",\r\n        \"stock_uom\",\r\n        \"custom_repeat_final_rate_price\",\r\n        \"description\",\r\n      ],\r\n      limit_page_length: 500,\r\n    },\r\n    callback: function (r) {\r\n      if (r.message && r.message.length > 0) {\r\n        // Get unique item groups\r\n        let item_groups = [\"All Groups\"];\r\n        let unique_groups = [\r\n          ...new Set(r.message.map((item) => item.item_group)),\r\n        ];\r\n        item_groups = item_groups.concat(unique_groups.sort());\r\n\r\n        // Create dialog with item list\r\n        // TO CUSTOMIZE DIALOG SIZE: Add 'size' property below\r\n        // Options: 'small', 'medium', 'large', 'extra-large'\r\n        // Example: size: 'extra-large'\r\n        let d = new frappe.ui.Dialog({\r\n          title: __(\"Select Items for {0}\", [frm.doc.supplier]),\r\n          size: \"extra-large\", // Dialog width: small=400px, medium=600px, large=800px, extra-large=1140px\r\n          fields: [\r\n            {\r\n              fieldname: \"item_group_filter\",\r\n              fieldtype: \"Select\",\r\n              label: __(\"Filter by Item Group\"),\r\n              options: item_groups.join(\"\\n\"),\r\n              default: \"All Groups\",\r\n              onchange: function () {\r\n                filter_items_by_group(d, this.value, r.message);\r\n              },\r\n            },\r\n            {\r\n              fieldname: \"items_html\",\r\n              fieldtype: \"HTML\",\r\n            },\r\n          ],\r\n          primary_action_label: __(\"Add Selected Items\"),\r\n          primary_action: function () {\r\n            let selected_items = [];\r\n            d.$wrapper.find('input[type=\"checkbox\"]:checked').each(function () {\r\n              if ($(this).attr(\"id\") !== \"select-all-items\") {\r\n                selected_items.push($(this).data(\"item-code\"));\r\n              }\r\n            });\r\n\r\n            if (selected_items.length > 0) {\r\n              // Step 1: Add all items to the grid first\r\n              let added_rows = [];\r\n              selected_items.forEach(function (item_code) {\r\n                let row = frm.add_child(\"items\");\r\n                frappe.model.set_value(\r\n                  row.doctype,\r\n                  row.name,\r\n                  \"item_code\",\r\n                  item_code\r\n                );\r\n                // Set default quantity to 1\r\n                frappe.model.set_value(row.doctype, row.name, \"qty\", 1);\r\n                added_rows.push({ row: row, item_code: item_code });\r\n              });\r\n\r\n              // Refresh grid to show items\r\n              frm.refresh_field(\"items\");\r\n\r\n              // Step 2: Wait 300ms, then fetch and populate all price fields\r\n              setTimeout(function () {\r\n                // Fetch all items in parallel (faster than sequential)\r\n                let fetch_promises = added_rows.map(function (row_data) {\r\n                  return new Promise(function (resolve, reject) {\r\n                    frappe.call({\r\n                      method: \"frappe.client.get\",\r\n                      args: {\r\n                        doctype: \"Item\",\r\n                        name: row_data.item_code,\r\n                      },\r\n                      callback: function (r) {\r\n                        if (r.message) {\r\n                          resolve({ row: row_data.row, item: r.message });\r\n                        } else {\r\n                          reject(\"Item not found: \" + row_data.item_code);\r\n                        }\r\n                      },\r\n                      error: function (err) {\r\n                        reject(err);\r\n                      },\r\n                    });\r\n                  });\r\n                });\r\n\r\n                // Wait for all fetches to complete\r\n                Promise.all(fetch_promises)\r\n                  .then(function (results) {\r\n                    // Step 3: Populate all fields for each row\r\n                    results.forEach(function (result) {\r\n                      let row = result.row;\r\n                      let item = result.item;\r\n\r\n                      // Populate Model Number\r\n                      if (item.custom_item_model) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"custom_model_number\",\r\n                          item.custom_item_model\r\n                        );\r\n                      }\r\n\r\n                      // Populate Rate (main price field)\r\n                      if (item.custom_repeat_final_rate_price) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"rate\",\r\n                          item.custom_repeat_final_rate_price\r\n                        );\r\n                      }\r\n\r\n                      // Populate Rate -Price (Company Currency)-\r\n                      if (item.custom_repeat_final_rate_price) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"custom_price_company_currency\",\r\n                          item.custom_repeat_final_rate_price\r\n                        );\r\n                      }\r\n\r\n                      // Populate Price Breakdown Fields\r\n                      if (item.custom_current_final_price_list) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"custom_final_price_list\",\r\n                          item.custom_current_final_price_list\r\n                        );\r\n                      }\r\n\r\n                      if (item.custom_current_final_promo) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"custom_final_promo\",\r\n                          item.custom_current_final_promo\r\n                        );\r\n                      }\r\n\r\n                      if (item.custom_current_final_sellout_promo) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"custom_final_sellout_promo\",\r\n                          item.custom_current_final_sellout_promo\r\n                        );\r\n                      }\r\n\r\n                      if (item.custom_repeat_invoice_discount) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"custom_repeat_invoice_discount\",\r\n                          item.custom_repeat_invoice_discount\r\n                        );\r\n                      }\r\n\r\n                      if (item.custom_repeat_cash_discount) {\r\n                        frappe.model.set_value(\r\n                          row.doctype,\r\n                          row.name,\r\n                          \"custom_repeat_cash_discount\",\r\n                          item.custom_repeat_cash_discount\r\n                        );\r\n                      }\r\n                    });\r\n\r\n                    // Step 4: Final refresh and show success\r\n                    frm.refresh_field(\"items\");\r\n                    frappe.show_alert({\r\n                      message: __(\r\n                        \"{0} items added with all price fields populated\",\r\n                        [selected_items.length]\r\n                      ),\r\n                      indicator: \"green\",\r\n                    });\r\n                  })\r\n                  .catch(function (error) {\r\n                    console.error(\"Error fetching item details:\", error);\r\n                    frappe.show_alert({\r\n                      message: __(\r\n                        \"Items added but some price fields may not be populated. Check console for errors.\"\r\n                      ),\r\n                      indicator: \"orange\",\r\n                    });\r\n                  });\r\n              }, 300); // 300ms delay\r\n\r\n              // Close dialog immediately after items are added\r\n              d.hide();\r\n            } else {\r\n              frappe.msgprint(__(\"Please select at least one item\"));\r\n            }\r\n          },\r\n        });\r\n\r\n        // Render initial table with all items\r\n        render_items_table(d, r.message);\r\n        d.show();\r\n      } else {\r\n        frappe.msgprint(\r\n          __(\"No items found for supplier {0}\", [frm.doc.supplier])\r\n        );\r\n      }\r\n    },\r\n  });\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.445218",
  "module": "Electro Zone",
  "name": "Item - Recalculate Price on Sellout Included Change",
  "script": "// Item - Recalculate Price on Sellout Included Change (ERPNext v15.8+)\r\n// Purpose:\r\n// - When user changes the \"Sellout Included\" checkbox, immediately recalculate final price\r\n// - ALWAYS call Rebate List recalculation API to update latest record\r\n// - Provides instant feedback with detailed logging\r\n//\r\n// Business Rule:\r\n// - Checked (1): Final Price = Price List - Promo - Sellout Promo (sellout INCLUDED)\r\n// - Unchecked (0): Final Price = Price List - Promo (sellout EXCLUDED)\r\n//\r\n// Trigger: When custom_sellout_included checkbox changes\r\n\r\nfrappe.ui.form.on(\"Item\", {\r\n  custom_sellout_included(frm) {\r\n    // Only recalculate if document exists (not new)\r\n    if (!frm.is_new()) {\r\n      recalculate_final_price_and_rebate(frm);\r\n    } else {\r\n      console.log(\"Skipped: Document is new\");\r\n    }\r\n  },\r\n});\r\n\r\nfunction recalculate_final_price_and_rebate(frm) {\r\n  // Get current pricing data from Item fields\r\n  let price_list = frm.doc.custom_current_final_price_list || 0;\r\n  let promo = frm.doc.custom_current_final_promo || 0;\r\n  let sellout = frm.doc.custom_current_final_sellout_promo || 0;\r\n  let sellout_included = frm.doc.custom_sellout_included || 0;\r\n\r\n  // Calculate final price based on checkbox state\r\n  let final_price = 0;\r\n  let calculation_note = \"\";\r\n\r\n  if (sellout_included) {\r\n    // Checked: Include sellout promo in calculation\r\n    final_price = price_list - promo - sellout;\r\n    calculation_note = `${price_list} - ${promo} - ${sellout} = ${final_price} (Sellout INCLUDED)`;\r\n  } else {\r\n    // Unchecked (default): Exclude sellout promo\r\n    final_price = price_list - promo;\r\n    calculation_note = `${price_list} - ${promo} = ${final_price} (Sellout EXCLUDED)`;\r\n  }\r\n\r\n  // Round to 2 decimal places for currency precision\r\n  final_price = Math.round(final_price * 100) / 100;\r\n\r\n  // Update the calculated field\r\n  frm.set_value(\"custom_current_final_price_list_calculated\", final_price);\r\n\r\n  // Show user feedback\r\n  frappe.show_alert({\r\n    message:\r\n      __(\"Final price recalculated: \") +\r\n      final_price +\r\n      \" (\" +\r\n      (sellout_included ? \"Sellout INCLUDED\" : \"Sellout EXCLUDED\") +\r\n      \")\",\r\n    indicator: \"green\",\r\n  });\r\n\r\n  frm\r\n    .save()\r\n    .then(() => {\r\n      // Now call the API to update Rebate List\r\n      call_rebate_recalculation_api(frm);\r\n    })\r\n    .catch((error) => {\r\n      frappe.show_alert({\r\n        message: __(\"Failed to save Item. Rebate List not updated.\"),\r\n        indicator: \"red\",\r\n      });\r\n    });\r\n}\r\n\r\nfunction call_rebate_recalculation_api(frm) {\r\n  frappe.call({\r\n    method: \"recalculate_rebate_for_item\",\r\n    args: {\r\n      item_code: frm.doc.name,\r\n    },\r\n    callback: function (r) {\r\n      if (r.message && r.message.success) {\r\n        if (r.message.updated_count > 0) {\r\n          frappe.show_alert({\r\n            message: __(\r\n              `âœ… Updated ${r.message.updated_count} Rebate List record(s) with new Final Price List: ${r.message.new_final_price_list}`\r\n            ),\r\n            indicator: \"green\",\r\n          });\r\n          frm.reload_doc();\r\n        } else {\r\n          frappe.show_alert({\r\n            message: __(\"No Rebate List records found to update.\"),\r\n            indicator: \"blue\",\r\n          });\r\n        }\r\n      } else if (r.message && !r.message.success) {\r\n        frappe.show_alert({\r\n          message: __(\r\n            r.message.message || \"Failed to update Rebate List records.\"\r\n          ),\r\n          indicator: \"orange\",\r\n        });\r\n      } else {\r\n      }\r\n    },\r\n    error: function (error) {\r\n      frappe.show_alert({\r\n        message: __(\"Error calling Rebate List recalculation API.\"),\r\n        indicator: \"red\",\r\n      });\r\n    },\r\n  });\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.441394",
  "module": "Electro Zone",
  "name": "Purchase Order - Price Edit Status Color Indicator",
  "script": "// Purchase Order - Price Edit Status Color Indicator (ERPNext v15.8+)\r\n// Purpose:\r\n// - Add colored indicators to Price Edit Status field\r\n// - Green for \"Automatic\" (default, fetched from Item)\r\n// - Blue for \"Manually Edited\" (user has unlocked and edited prices)\r\n\r\nfrappe.ui.form.on(\"Purchase Order\", {\r\n  refresh(frm) {\r\n    apply_status_indicator(frm);\r\n  },\r\n\r\n  onload(frm) {\r\n    apply_status_indicator(frm);\r\n  },\r\n\r\n  custom_price_edit_status(frm) {\r\n    // Trigger when status field changes\r\n    apply_status_indicator(frm);\r\n  },\r\n});\r\n\r\nfunction apply_status_indicator(frm) {\r\n  if (!frm.doc.custom_price_edit_status) return;\r\n\r\n  // Set indicator color based on status\r\n  if (frm.doc.custom_price_edit_status === \"Manually Edited\") {\r\n    // Blue indicator for manual edits\r\n    frm.set_df_property(\r\n      \"custom_price_edit_status\",\r\n      \"label_style\",\r\n      \"primary\"\r\n    );\r\n  } else if (frm.doc.custom_price_edit_status === \"Automatic\") {\r\n    // Green indicator for automatic (default)\r\n    frm.set_df_property(\r\n      \"custom_price_edit_status\",\r\n      \"label_style\",\r\n      \"success\"\r\n    );\r\n  }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.438680",
  "module": "Electro Zone",
  "name": "Purchase Order - Real-Time Gift Item Calculation",
  "script": "// Purchase Order - Real-Time Gift Item Calculation with Manual Price Edit v5.0\r\n// Purpose:\r\n// - Calculate gift item adjustments in real-time as user edits the form\r\n// - custom_price_total = sum of (custom_price_company_currency Ã— qty) - baseline total\r\n// - Rate field is adjusted to distribute gift value across all items\r\n// - Total field (ERPNext standard) will differ from custom_price_total when gifts applied\r\n// - Allow manual editing of custom_price_company_currency when checkbox is checked\r\n// - Track price edit status automatically (Automatic vs Manually Edited)\r\n//\r\n// Key Features (v5.0):\r\n// - Added automatic Price Edit Status tracking\r\n// - Status updates in real-time when manual edit checkbox is toggled\r\n// - Status persists and shows in List View for easy filtering\r\n// - Rate calculation uses CURRENT custom_price_company_currency\r\n// - Manual price edit triggers Price Total and gift percentage recalculation\r\n\r\n// ============================================================================\r\n// SCRIPT CONFIGURATION\r\n// ============================================================================\r\n\r\n// Store original custom_price_company_currency values (for item_code change tracking only)\r\nlet original_custom_prices = {};\r\n\r\n// Recursion guard to prevent infinite loops\r\nlet is_calculating_gifts = false;\r\n\r\n// ============================================================================\r\n// MAIN EVENT HANDLERS\r\n// ============================================================================\r\n\r\nfrappe.ui.form.on(\"Purchase Order\", {\r\n  refresh(frm) {\r\n    // Calculate custom_price_total on refresh\r\n    if (frm.doc.docstatus === 0) {\r\n      calculate_custom_price_total_only(frm);\r\n    }\r\n\r\n    // Update price edit status on refresh\r\n    update_price_edit_status(frm);\r\n\r\n    // Apply field locks on refresh - use delay to ensure grid is rendered\r\n    setTimeout(() => {\r\n      apply_field_locks_on_all_rows(frm);\r\n    }, 300);\r\n  },\r\n\r\n  onload(frm) {\r\n    // Update price edit status on load\r\n    update_price_edit_status(frm);\r\n\r\n    // Apply field locks when form first loads - use delay to ensure grid is rendered\r\n    setTimeout(() => {\r\n      apply_field_locks_on_all_rows(frm);\r\n    }, 500);\r\n  },\r\n});\r\n\r\nfrappe.ui.form.on(\"Purchase Order Item\", {\r\n  // Trigger when item is added\r\n  items_add(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n\r\n    let row = locals[cdt][cdn];\r\n\r\n    // Store original custom_price_company_currency when item is first added\r\n    if (!original_custom_prices[cdn]) {\r\n      original_custom_prices[cdn] = row.custom_price_company_currency || 0;\r\n    }\r\n\r\n    // Apply lock to this new row (default: locked)\r\n    setTimeout(() => {\r\n      set_field_read_only(frm, cdn, \"custom_price_company_currency\", true);\r\n    }, 200);\r\n  },\r\n\r\n  // Trigger when grid row is rendered\r\n  items_form_render(frm, cdt, cdn) {\r\n    let row = locals[cdt][cdn];\r\n\r\n    // Apply lock based on checkbox state when row is rendered\r\n    let should_lock = !row.custom_allow_manual_price_edit;\r\n    setTimeout(() => {\r\n      set_field_read_only(\r\n        frm,\r\n        cdn,\r\n        \"custom_price_company_currency\",\r\n        should_lock\r\n      );\r\n    }, 50);\r\n  },\r\n\r\n  // Trigger when manual edit checkbox changes\r\n  custom_allow_manual_price_edit(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n\r\n    let row = locals[cdt][cdn];\r\n\r\n    if (row.custom_allow_manual_price_edit) {\r\n      // Checkbox CHECKED - Make field editable for THIS ROW ONLY\r\n      set_field_read_only(frm, cdn, \"custom_price_company_currency\", false);\r\n\r\n      // Update status to \"Manually Edited\"\r\n      update_price_edit_status(frm);\r\n\r\n      frappe.show_alert({\r\n        message: __(\"Price field unlocked for manual editing\"),\r\n        indicator: \"blue\",\r\n      });\r\n    } else {\r\n      // Checkbox UNCHECKED - Revert to original fetched value\r\n      set_field_read_only(frm, cdn, \"custom_price_company_currency\", true);\r\n\r\n      // FIX #4: Revert to original value stored when item_code was selected\r\n      // This allows \"Fetch From\" to work naturally without API calls\r\n      let original_price = original_custom_prices[cdn] || 0;\r\n\r\n      // Temporarily disable gift calculation during revert\r\n      let temp_is_calculating = is_calculating_gifts;\r\n      is_calculating_gifts = true;\r\n\r\n      // Revert to original value\r\n      if (row.custom_price_company_currency !== original_price) {\r\n        frappe.model.set_value(\r\n          cdt,\r\n          cdn,\r\n          \"custom_price_company_currency\",\r\n          original_price\r\n        );\r\n      }\r\n\r\n      // Re-enable gift calculation after a short delay\r\n      setTimeout(() => {\r\n        is_calculating_gifts = temp_is_calculating;\r\n\r\n        // Update status (may change back to \"Automatic\" if no other rows are edited)\r\n        update_price_edit_status(frm);\r\n\r\n        frappe.show_alert({\r\n          message: __(\"Price reverted to original value\"),\r\n          indicator: \"green\",\r\n        });\r\n\r\n        // Recalculate gift items with reverted price\r\n        calculate_gift_items(frm);\r\n      }, 100);\r\n    }\r\n  },\r\n\r\n  // Trigger when custom_price_company_currency changes manually\r\n  custom_price_company_currency(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n\r\n    let row = locals[cdt][cdn];\r\n\r\n    // FIX #2 & #3: Remove direct rate sync - let calculate_gift_items handle it\r\n    // Just recalculate gift items - they will use current custom_price_company_currency\r\n    if (row.custom_allow_manual_price_edit) {\r\n      frappe.show_alert({\r\n        message: __(\r\n          \"Price updated - recalculating totals and gift distribution\"\r\n        ),\r\n        indicator: \"blue\",\r\n      });\r\n    } else {\r\n      // Update cache if manual edit is NOT allowed (auto-fetched value)\r\n      original_custom_prices[cdn] = row.custom_price_company_currency || 0;\r\n    }\r\n\r\n    // Recalculate gift items (this will update Price Total, gift %, and rates)\r\n    calculate_gift_items(frm);\r\n  },\r\n\r\n  // Trigger when gift checkbox changes\r\n  custom_is_gift(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n    calculate_gift_items(frm);\r\n  },\r\n\r\n  // Trigger when qty changes\r\n  qty(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n    calculate_gift_items(frm);\r\n  },\r\n\r\n  // Trigger when rate changes manually (when no gifts active)\r\n  rate(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n\r\n    // FIX #5: Simplified - only recalculate if no gifts are active\r\n    if (!is_gift_calculation_active(frm)) {\r\n      calculate_gift_items(frm);\r\n    }\r\n    // If gifts ARE active, don't recalculate (rate change is from calculate_gift_items)\r\n  },\r\n\r\n  // Trigger when item_code changes\r\n  item_code(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n\r\n    let row = locals[cdt][cdn];\r\n\r\n    // Wait for item to fully load with all fetched fields\r\n    setTimeout(() => {\r\n      // Store new custom_price_company_currency as original for this item\r\n      original_custom_prices[cdn] = row.custom_price_company_currency || 0;\r\n\r\n      // Re-apply lock after item data loads (unless checkbox is checked)\r\n      if (!row.custom_allow_manual_price_edit) {\r\n        set_field_read_only(frm, cdn, \"custom_price_company_currency\", true);\r\n      }\r\n\r\n      // Recalculate with new item\r\n      calculate_gift_items(frm);\r\n    }, 500);\r\n  },\r\n\r\n  // Trigger when item is removed\r\n  items_remove(frm, cdt, cdn) {\r\n    if (frm.doc.docstatus !== 0 || is_calculating_gifts) return;\r\n\r\n    // Clean up stored values\r\n    delete original_custom_prices[cdn];\r\n    calculate_gift_items(frm);\r\n  },\r\n});\r\n\r\n// ============================================================================\r\n// HELPER FUNCTIONS\r\n// ============================================================================\r\n\r\nfunction set_field_read_only(frm, cdn, fieldname, is_read_only) {\r\n  // Set read-only property for a specific field in a specific row\r\n  // This function uses both API updates and direct DOM manipulation\r\n  let grid = frm.fields_dict.items.grid;\r\n  if (!grid) return;\r\n\r\n  let grid_row = grid.grid_rows_by_docname[cdn];\r\n  if (!grid_row) return;\r\n\r\n  // Update the field definition in multiple places\r\n  if (grid_row.fields_dict && grid_row.fields_dict[fieldname]) {\r\n    let row_field = grid_row.fields_dict[fieldname];\r\n    if (row_field && row_field.df) {\r\n      row_field.df.read_only = is_read_only ? 1 : 0;\r\n    }\r\n  }\r\n\r\n  // Update in docfields array\r\n  if (grid_row.docfields) {\r\n    for (let i = 0; i < grid_row.docfields.length; i++) {\r\n      if (grid_row.docfields[i].fieldname === fieldname) {\r\n        grid_row.docfields[i].read_only = is_read_only ? 1 : 0;\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  // CRITICAL: Direct DOM manipulation to enable/disable the input field\r\n  setTimeout(() => {\r\n    // Find the input field in the DOM using the row index and field name\r\n    let $input = $(grid_row.wrapper).find(\r\n      `[data-fieldname=\"${fieldname}\"] input`\r\n    );\r\n\r\n    if ($input.length > 0) {\r\n      if (is_read_only) {\r\n        // Lock the field\r\n        $input.prop(\"readonly\", true);\r\n        $input.prop(\"disabled\", true);\r\n        $input.addClass(\"disabled-field\");\r\n        $input.css({\r\n          \"background-color\": \"#f5f5f5\",\r\n          cursor: \"not-allowed\",\r\n          opacity: \"0.7\",\r\n        });\r\n      } else {\r\n        // Unlock the field\r\n        $input.prop(\"readonly\", false);\r\n        $input.prop(\"disabled\", false);\r\n        $input.removeClass(\"disabled-field\");\r\n        $input.css({\r\n          \"background-color\": \"#ffffff\",\r\n          cursor: \"text\",\r\n          opacity: \"1\",\r\n        });\r\n        // Focus the field to show it's editable\r\n        $input.focus();\r\n      }\r\n    }\r\n  }, 50);\r\n}\r\n\r\nfunction apply_field_locks_on_all_rows(frm) {\r\n  // Apply locks to all rows based on checkbox state\r\n  if (!frm.doc.items || !frm.fields_dict.items) return;\r\n\r\n  let grid = frm.fields_dict.items.grid;\r\n  if (!grid || !grid.grid_rows) return;\r\n\r\n  // Get the field definition from the grid\r\n  let field_obj = grid.get_field(\"custom_price_company_currency\");\r\n\r\n  // Iterate through all grid rows\r\n  grid.grid_rows.forEach((grid_row) => {\r\n    if (grid_row && grid_row.doc) {\r\n      let item = grid_row.doc;\r\n      let should_lock = !item.custom_allow_manual_price_edit;\r\n\r\n      // Update field in this specific row's fields_dict\r\n      if (\r\n        grid_row.fields_dict &&\r\n        grid_row.fields_dict[\"custom_price_company_currency\"]\r\n      ) {\r\n        grid_row.fields_dict[\"custom_price_company_currency\"].df.read_only =\r\n          should_lock ? 1 : 0;\r\n      }\r\n    }\r\n  });\r\n\r\n  // Refresh the entire grid to apply changes\r\n  grid.refresh();\r\n}\r\n\r\nfunction calculate_custom_price_total_only(frm) {\r\n  // Calculate ONLY custom_price_total without triggering gift calculation\r\n  if (!frm.doc.items || frm.doc.items.length === 0) {\r\n    frm.set_value(\"custom_price_total\", 0);\r\n    return;\r\n  }\r\n\r\n  let custom_price_total = 0;\r\n  frm.doc.items.forEach((item) => {\r\n    let qty = item.qty || 0;\r\n    let base_price = item.custom_price_company_currency || 0;\r\n    custom_price_total = custom_price_total + qty * base_price;\r\n  });\r\n\r\n  frm.set_value(\"custom_price_total\", custom_price_total);\r\n}\r\n\r\nfunction update_price_edit_status(frm) {\r\n  // Update Price Edit Status based on manual edit checkboxes\r\n  // Check if ANY item has custom_allow_manual_price_edit checked\r\n  if (!frm.doc.items || frm.doc.items.length === 0) {\r\n    frm.set_value(\"custom_price_edit_status\", \"Automatic\");\r\n    return;\r\n  }\r\n\r\n  let has_manual_edit = frm.doc.items.some(\r\n    (item) => item.custom_allow_manual_price_edit === 1\r\n  );\r\n\r\n  let new_status = has_manual_edit ? \"Manually Edited\" : \"Automatic\";\r\n\r\n  // Only update if status has changed (prevent unnecessary triggers)\r\n  if (frm.doc.custom_price_edit_status !== new_status) {\r\n    frm.set_value(\"custom_price_edit_status\", new_status);\r\n  }\r\n}\r\n\r\nfunction is_gift_calculation_active(frm) {\r\n  // Check if any items are marked as gifts\r\n  if (!frm.doc.items) return false;\r\n  return frm.doc.items.some((item) => item.custom_is_gift === 1);\r\n}\r\n\r\nfunction calculate_gift_items(frm) {\r\n  // Prevent recursive calls and conflicts with other scripts\r\n  if (is_calculating_gifts) return;\r\n\r\n  // Use try-finally to ensure flag is always reset\r\n  try {\r\n    is_calculating_gifts = true;\r\n\r\n    if (!frm.doc.items || frm.doc.items.length === 0) {\r\n      frm.set_value(\"custom_price_total\", 0);\r\n      return;\r\n    }\r\n\r\n    // ========================================================================\r\n    // STEP 1: Calculate custom_price_total using custom_price_company_currency\r\n    // ========================================================================\r\n    let custom_price_total = 0;\r\n    frm.doc.items.forEach((item) => {\r\n      let qty = item.qty || 0;\r\n      let base_price = item.custom_price_company_currency || 0;\r\n      let line_total = qty * base_price;\r\n      custom_price_total = custom_price_total + line_total;\r\n    });\r\n\r\n    // Update custom_price_total field (baseline total)\r\n    frm.set_value(\"custom_price_total\", custom_price_total);\r\n\r\n    // ========================================================================\r\n    // STEP 2: Calculate original total using custom_price_company_currency\r\n    // ========================================================================\r\n    let original_total = 0;\r\n    frm.doc.items.forEach((item) => {\r\n      let qty = item.qty || 0;\r\n      let base_price = item.custom_price_company_currency || 0;\r\n\r\n      let line_total = qty * base_price;\r\n      original_total = original_total + line_total;\r\n    });\r\n\r\n    // ========================================================================\r\n    // STEP 3: Calculate gift subtotal using custom_price_company_currency\r\n    // ========================================================================\r\n    let gift_subtotal = 0;\r\n    frm.doc.items.forEach((item) => {\r\n      if (item.custom_is_gift === 1) {\r\n        let qty = item.qty || 0;\r\n        let base_price = item.custom_price_company_currency || 0;\r\n        gift_subtotal = gift_subtotal + qty * base_price;\r\n      }\r\n    });\r\n\r\n    // ========================================================================\r\n    // STEP 4: If no gifts, set rates to match custom_price_company_currency\r\n    // ========================================================================\r\n    if (gift_subtotal === 0 || original_total === 0) {\r\n      frm.doc.items.forEach((item) => {\r\n        let base_price = item.custom_price_company_currency || 0;\r\n\r\n        // Set rate to match custom_price_company_currency (no gift adjustment)\r\n        if (Math.abs(item.rate - base_price) > 0.01) {\r\n          frappe.model.set_value(item.doctype, item.name, \"rate\", base_price);\r\n        }\r\n      });\r\n      frm.refresh_field(\"items\");\r\n      return;\r\n    }\r\n\r\n    // ========================================================================\r\n    // STEP 5: Calculate gift percentage and apply to all items\r\n    // FIX #1: Use CURRENT custom_price_company_currency instead of original_rates\r\n    // ========================================================================\r\n    let gift_percentage = gift_subtotal / original_total;\r\n\r\n    frm.doc.items.forEach((item) => {\r\n      let qty = item.qty || 0;\r\n      if (qty === 0) return;\r\n\r\n      // FIX #1: Use current custom_price_company_currency as base (not cached original_rates)\r\n      let base_price = item.custom_price_company_currency || 0;\r\n      let original_line_amount = qty * base_price;\r\n\r\n      // Calculate adjusted amount (reduce by gift percentage)\r\n      let adjusted_amount = original_line_amount * (1 - gift_percentage);\r\n\r\n      // Calculate new rate = custom_price_company_currency Ã— (1 - gift_percentage)\r\n      let new_rate = adjusted_amount / qty;\r\n\r\n      // Update rate only if different (prevent unnecessary triggers)\r\n      if (Math.abs(item.rate - new_rate) > 0.01) {\r\n        frappe.model.set_value(item.doctype, item.name, \"rate\", new_rate);\r\n      }\r\n    });\r\n\r\n    // Refresh the items table to show updated values\r\n    frm.refresh_field(\"items\");\r\n  } finally {\r\n    // Always reset the flag, even if error occurs\r\n    is_calculating_gifts = false;\r\n  }\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Item",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.444028",
  "module": "Electro Zone",
  "name": "Item - Download Excel Button",
  "script": "// Client Script: Item - Download Excel Button\r\n// Apply To: Item (List View)\r\n// Purpose: Add \"Download Excel\" button with SheetJS client-side generation\r\n\r\n// Load ExcelJS library for Excel generation\r\nif (!window.ExcelJS) {\r\n  frappe.require(\r\n    \"https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js\",\r\n    function () {\r\n     //nothing\r\n    }\r\n  );\r\n}\r\n\r\nfrappe.listview_settings[\"Item\"] = frappe.listview_settings[\"Item\"] || {};\r\n\r\nfrappe.listview_settings[\"Item\"].onload = function (listview) {\r\n  // Add custom button to toolbar\r\n  listview.page.add_inner_button(\r\n    __(\"Download Stock\"),\r\n    function () {\r\n      generate_item_stock_excel();\r\n    },\r\n    __(\"Excel\")\r\n  );\r\n};\r\n\r\n/**\r\n * Convert numeric stock quantity to text label\r\n * @param {number} qty - Numeric stock quantity\r\n * @returns {string} - Text label (Zero, Low, Mid, High)\r\n */\r\nfunction convertQtyToLabel(qty) {\r\n  if (qty === 0) {\r\n    return \"Zero\";\r\n  } else if (qty >= 1 && qty <= 3) {\r\n    return \"Low\";\r\n  } else if (qty >= 4 && qty <= 9) {\r\n    return \"Mid\";\r\n  } else if (qty >= 10) {\r\n    return \"High\";\r\n  } else {\r\n    // Fallback for negative or invalid values\r\n    return \"Zero\";\r\n  }\r\n}\r\n\r\n/**\r\n * Get background color for stock level label (ExcelJS format)\r\n * @param {string} label - Stock level label (Zero, Low, Mid, High)\r\n * @returns {string|null} - ARGB color code for ExcelJS, or null for no background\r\n */\r\nfunction getExcelJSColor(label) {\r\n  const colors = {\r\n    Zero: null, // No background color\r\n    Low: \"FFFF6B6B\", // Light Red\r\n    Mid: \"FFFFD93D\", // Light Yellow\r\n    High: \"FF6BCF7F\", // Light Green\r\n  };\r\n\r\n  return colors[label] !== undefined ? colors[label] : null;\r\n}\r\n\r\n/**\r\n * Generate and download Excel file with item stock data\r\n */\r\nfunction generate_item_stock_excel() {\r\n  // Check if ExcelJS library is loaded\r\n  if (!window.ExcelJS) {\r\n    frappe.msgprint({\r\n      title: __(\"Library Not Loaded\"),\r\n      message: __(\r\n        \"ExcelJS library is still loading. Please try again in a moment.\"\r\n      ),\r\n      indicator: \"orange\",\r\n    });\r\n    return;\r\n  }\r\n\r\n  // Show loading indicator\r\n  frappe.show_alert(\r\n    {\r\n      message: __(\"Fetching item data...\"),\r\n      indicator: \"blue\",\r\n    },\r\n    5\r\n  );\r\n\r\n  // Call server API to get item data\r\n  frappe.call({\r\n    method: \"item_list_get_items_with_stock\",\r\n    type: \"GET\",\r\n    freeze: true,\r\n    freeze_message: __(\"Loading item data...\"),\r\n    callback: function (r) {\r\n      if (r.message && r.message.success) {\r\n        // Data fetched successfully - generate Excel\r\n        const items = r.message.items;\r\n        const warehouses = r.message.warehouses;\r\n        const total_count = r.message.total_count;\r\n\r\n        if (total_count === 0) {\r\n          frappe.msgprint({\r\n            title: __(\"No Data\"),\r\n            message: __(\"No stock items found to export.\"),\r\n            indicator: \"orange\",\r\n          });\r\n          return;\r\n        }\r\n\r\n        // Generate Excel file using ExcelJS\r\n        try {\r\n          // Create workbook and worksheet\r\n          const workbook = new ExcelJS.Workbook();\r\n          const worksheet = workbook.addWorksheet(\"Items with Stock\");\r\n\r\n          // Define border style for all cells\r\n          const borderStyle = {\r\n            top: { style: \"thin\", color: { argb: \"FF000000\" } },\r\n            left: { style: \"thin\", color: { argb: \"FF000000\" } },\r\n            bottom: { style: \"thin\", color: { argb: \"FF000000\" } },\r\n            right: { style: \"thin\", color: { argb: \"FF000000\" } },\r\n          };\r\n\r\n          // Add header row with bold font and borders\r\n          const headerRow = worksheet.addRow([\r\n            \"Item Code\",\r\n            \"Item Model\",\r\n            \"Description\",\r\n            ...warehouses,\r\n          ]);\r\n          headerRow.font = { bold: true };\r\n\r\n          // Apply borders to header cells\r\n          headerRow.eachCell((cell) => {\r\n            cell.border = borderStyle;\r\n          });\r\n\r\n          // Add data rows with colors and borders\r\n          items.forEach((item) => {\r\n            // Prepare row data\r\n            const rowData = [\r\n              item.item_code,\r\n              item.custom_item_model,\r\n              item.description,\r\n            ];\r\n\r\n            // Add warehouse quantities as text labels\r\n            warehouses.forEach((warehouse) => {\r\n              const qty = item[warehouse] || 0;\r\n              rowData.push(convertQtyToLabel(qty));\r\n            });\r\n\r\n            // Add row to worksheet\r\n            const row = worksheet.addRow(rowData);\r\n\r\n            // Apply borders to all cells in the row\r\n            row.eachCell((cell) => {\r\n              cell.border = borderStyle;\r\n            });\r\n\r\n            // Apply colors to warehouse columns (starting at column 4 = D)\r\n            warehouses.forEach((warehouse, idx) => {\r\n              const qty = item[warehouse] || 0;\r\n              const label = convertQtyToLabel(qty);\r\n              const cellIndex = 4 + idx; // Columns 4-9 (D-I)\r\n              const cell = row.getCell(cellIndex);\r\n\r\n              // Apply background color based on label (null = no background for Zero)\r\n              const bgColor = getExcelJSColor(label);\r\n              if (bgColor) {\r\n                cell.fill = {\r\n                  type: \"pattern\",\r\n                  pattern: \"solid\",\r\n                  fgColor: { argb: bgColor },\r\n                };\r\n              }\r\n            });\r\n          });\r\n\r\n          // Set column widths for better readability\r\n          worksheet.getColumn(1).width = 20; // Item Code\r\n          worksheet.getColumn(2).width = 20; // Item Model\r\n          worksheet.getColumn(3).width = 40; // Description\r\n          worksheet.getColumn(4).width = 18; // Store Display - EZ\r\n          worksheet.getColumn(5).width = 20; // Store Warehouse - EZ\r\n          worksheet.getColumn(6).width = 15; // Damage - EZ\r\n          worksheet.getColumn(7).width = 20; // Damage For Sale - EZ\r\n          worksheet.getColumn(8).width = 18; // Zahran Main - EZ\r\n          worksheet.getColumn(9).width = 35; // Hold (Reserved / Pending Shipment) - EZ\r\n\r\n          // Generate filename with timestamp\r\n          const timestamp = frappe.datetime\r\n            .now_datetime()\r\n            .replace(/[\\s:]/g, \"_\");\r\n          const filename = `Item_Stock_Export_${timestamp}.xlsx`;\r\n\r\n          // Generate Excel file and download\r\n          workbook.xlsx\r\n            .writeBuffer()\r\n            .then((buffer) => {\r\n              // Create blob from buffer\r\n              const blob = new Blob([buffer], {\r\n                type: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n              });\r\n\r\n              // Create download link\r\n              const url = window.URL.createObjectURL(blob);\r\n              const a = document.createElement(\"a\");\r\n              a.href = url;\r\n              a.download = filename;\r\n              document.body.appendChild(a);\r\n              a.click();\r\n\r\n              // Cleanup\r\n              document.body.removeChild(a);\r\n              window.URL.revokeObjectURL(url);\r\n\r\n              // Show success message\r\n              frappe.show_alert(\r\n                {\r\n                  message: __(\"Excel file downloaded successfully: {0}\", [\r\n                    filename,\r\n                  ]),\r\n                  indicator: \"green\",\r\n                },\r\n                5\r\n              );\r\n            })\r\n            .catch((error) => {\r\n              console.error(\"Excel generation error:\", error);\r\n              frappe.msgprint({\r\n                title: __(\"Excel Generation Failed\"),\r\n                message: __(\"Failed to generate Excel file. Please try again.\"),\r\n                indicator: \"red\",\r\n              });\r\n            });\r\n        } catch (error) {\r\n          console.error(\"Excel generation error:\", error);\r\n          frappe.msgprint({\r\n            title: __(\"Excel Generation Failed\"),\r\n            message: __(\"Failed to generate Excel file. Please try again.\"),\r\n            indicator: \"red\",\r\n          });\r\n        }\r\n      } else {\r\n        frappe.msgprint({\r\n          title: __(\"Error\"),\r\n          message: __(\"Failed to fetch item data. Please try again.\"),\r\n          indicator: \"red\",\r\n        });\r\n      }\r\n    },\r\n    error: function (r) {\r\n      frappe.msgprint({\r\n        title: __(\"API Error\"),\r\n        message: __(\r\n          \"Failed to connect to server. Please check your connection and try again.\"\r\n        ),\r\n        indicator: \"red\",\r\n      });\r\n    },\r\n  });\r\n}",
  "view": "List"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.427301",
  "module": "Electro Zone",
  "name": "Purchase Receipt - Barcode Scan Handler",
  "script": "// Purchase Receipt - Barcode Scan Handler (With Server API)\r\n// Calls Server Script API to get PO ordered qty (bypasses Stock User permissions)\r\n// IMPORTANT: Completely overrides ERPNext's default barcode behavior\r\n// BLOCKS adding new rows if barcode not found in PR items table\r\n\r\nfrappe.ui.form.on(\"Purchase Receipt\", {\r\n  onload_post_render: function (frm) {\r\n    // Block ERPNext's default barcode scan behavior completely\r\n    // This prevents ERPNext from auto-adding new rows when scanning unknown barcodes\r\n    if (frm.fields_dict.scan_barcode) {\r\n      // Override the default barcode scanner handler\r\n      frm.fields_dict.scan_barcode.df.onchange = null;\r\n    }\r\n  },\r\n\r\n  scan_barcode: function (frm) {\r\n    let scanned_barcode = (frm.doc.scan_barcode || \"\").trim();\r\n    if (!scanned_barcode) return;\r\n\r\n    // CRITICAL: Prevent ERPNext default behavior\r\n    // Stop event propagation immediately\r\n    frm.doc.scan_barcode = \"\";\r\n    frm.refresh_field(\"scan_barcode\");\r\n\r\n    // Validation: Document must be Draft\r\n    if (frm.doc.docstatus !== 0) {\r\n      frappe.show_alert(\r\n        {\r\n          message: __(\"âš ï¸ Cannot scan on submitted document\"),\r\n          indicator: \"yellow\",\r\n        },\r\n        4\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Validation: Must have items\r\n    if (!frm.doc.items || frm.doc.items.length === 0) {\r\n      frappe.show_alert(\r\n        {\r\n          message: __(\r\n            \"âš ï¸ No items in PR. Create PR from Purchase Order first.\"\r\n          ),\r\n          indicator: \"yellow\",\r\n        },\r\n        4\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Step 1: Find item by barcode directly in PR items table\r\n    let pr_item_row = null;\r\n    let row_index = -1;\r\n\r\n    frm.doc.items.forEach(function (row, index) {\r\n      if (row.barcode === scanned_barcode) {\r\n        pr_item_row = row;\r\n        row_index = index;\r\n      }\r\n    });\r\n\r\n    // CRITICAL VALIDATION: Block if barcode not found in PR items\r\n    if (!pr_item_row) {\r\n      frappe.show_alert(\r\n        {\r\n          message: __(\"âŒ Barcode NOT in Purchase Receipt: {0} !\", [\r\n            scanned_barcode,\r\n          ]),\r\n          indicator: \"red\",\r\n        },\r\n        6\r\n      );\r\n\r\n      // Play error sound if available\r\n      if (frappe.utils.play_sound) {\r\n        frappe.utils.play_sound(\"error\");\r\n      }\r\n\r\n      return; // EXIT - Do NOT proceed\r\n    }\r\n\r\n    // Step 2: Get ordered quantity via Server Script API\r\n    let po_reference = pr_item_row.purchase_order || frm.doc.purchase_order;\r\n    let item_code = pr_item_row.item_code;\r\n\r\n    if (!po_reference) {\r\n      frappe.show_alert(\r\n        {\r\n          message: __(\"âŒ No Purchase Order reference found\"),\r\n          indicator: \"red\",\r\n        },\r\n        5\r\n      );\r\n      return;\r\n    }\r\n\r\n    // Call Server Script API (runs with elevated permissions)\r\n    frappe.call({\r\n      method: \"get_po_ordered_qty\",\r\n      args: {\r\n        po_reference: po_reference,\r\n        item_code: item_code,\r\n      },\r\n      callback: function (r) {\r\n        if (!r.message || !r.message.success) {\r\n          frappe.show_alert(\r\n            {\r\n              message: __(\"âŒ {0}\", [\r\n                r.message.error || \"Item not found in Purchase Order\",\r\n              ]),\r\n              indicator: \"red\",\r\n            },\r\n            5\r\n          );\r\n          return;\r\n        }\r\n\r\n        let ordered_qty = r.message.ordered_qty;\r\n        let current_qty = pr_item_row.custom_received_quantity || 0;\r\n        let new_qty = current_qty + 1;\r\n\r\n        // Step 3: Validate against ordered quantity\r\n        if (new_qty > ordered_qty) {\r\n          frappe.show_alert(\r\n            {\r\n              message: __(\"âŒ Max reached! {0} | Limit: {1}\", [\r\n                item_code,\r\n                ordered_qty,\r\n              ]),\r\n              indicator: \"red\",\r\n            },\r\n            5\r\n          );\r\n          return;\r\n        }\r\n\r\n        // Step 4: Increment custom_received_quantity by +1\r\n        frappe.model.set_value(\r\n          pr_item_row.doctype,\r\n          pr_item_row.name,\r\n          \"custom_received_quantity\",\r\n          new_qty\r\n        );\r\n\r\n        // Step 5: Show success message\r\n        frappe.show_alert(\r\n          {\r\n            message: __(\"âœ… {0} --> +1 (total: {1}/{2})\", [\r\n              item_code,\r\n              new_qty,\r\n              ordered_qty,\r\n            ]),\r\n            indicator: \"green\",\r\n          },\r\n          3\r\n        );\r\n\r\n        // Step 6: Focus on custom_received_quantity field and scroll to it\r\n        setTimeout(() => {\r\n          // Find the custom_received_quantity input field for this row\r\n          let qty_field = $(\r\n            `[data-name=\"${pr_item_row.name}\"] [data-fieldname=\"custom_received_quantity\"] input`\r\n          );\r\n\r\n          if (qty_field.length) {\r\n            // Focus on the field (keeps focus on row)\r\n            qty_field.focus();\r\n\r\n            // Scroll row into view if needed\r\n            qty_field[0].scrollIntoView({\r\n              behavior: \"smooth\",\r\n              block: \"center\",\r\n            });\r\n          }\r\n        }, 100);\r\n\r\n        // Refresh grid to show updated quantity\r\n        frm.refresh_field(\"items\");\r\n      },\r\n    });\r\n  },\r\n\r\n  refresh: function (frm) {\r\n    // Block adding new rows completely (prevents barcode auto-add)\r\n    if (frm.fields_dict.items && frm.fields_dict.items.grid) {\r\n      // Disable row addition at Grid API level\r\n      frm.fields_dict.items.grid.cannot_add_rows = true;\r\n\r\n      // Hide \"Add Row\" button visually\r\n      frm.fields_dict.items.grid.wrapper.find(\".grid-add-row\").hide();\r\n\r\n      // Hide row checkboxes (prevent deletion too)\r\n      frm.fields_dict.items.grid.wrapper.find(\".grid-row-check\").hide();\r\n    }\r\n\r\n    // Auto-focus barcode field on form load\r\n    if (frm.doc.docstatus === 0 && frm.doc.items && frm.doc.items.length > 0) {\r\n      setTimeout(function () {\r\n        if (frm.fields_dict.scan_barcode) {\r\n          frm.fields_dict.scan_barcode.$input.focus();\r\n        }\r\n      }, 500);\r\n    }\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Receipt",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.428361",
  "module": "Electro Zone",
  "name": "Purchase Receipt - Strict Controls (All Users)",
  "script": "// Purchase Receipt - Strict Controls (All Users)\r\n// Purpose:\r\n// - Hide financial fields for Stock Users\r\n// - Block adding new items (enforce PO-only workflow) - ALL USERS\r\n// - Block deleting items from grid - ALL USERS\r\n// - Show informative alerts\r\n// Apply To: Financial hiding for Stock User only, Item restrictions for ALL users\r\n\r\nfrappe.ui.form.on(\"Purchase Receipt\", {\r\n  refresh(frm) {\r\n    // Determine user role for conditional hiding\r\n    const isStockUserOnly =\r\n      frappe.user.has_role(\"Stock User\") &&\r\n      !frappe.user.has_role(\"System Manager\");\r\n\r\n    // -------------------- Remove All Action Buttons (Stock User Only) --------------------\r\n    if (isStockUserOnly && frm.doc.docstatus === 1) {\r\n      frm.page.clear_inner_toolbar();\r\n    }\r\n\r\n    // -------------------- Hide Tabs (Stock User Only) --------------------\r\n    if (isStockUserOnly) {\r\n      [\"more_info\", \"connections\"].forEach((tab) => {\r\n        if (frm.fields_dict[tab]) {\r\n          frm.set_df_property(tab, \"hidden\", 1);\r\n        }\r\n      });\r\n    }\r\n\r\n    // -------------------- Hide Status Indicators (Stock User Only) --------------------\r\n    if (isStockUserOnly) {\r\n      const statusFields = [\"status\", \"per_billed\"];\r\n      statusFields.forEach((field) => {\r\n        frm.set_df_property(field, \"hidden\", 1);\r\n      });\r\n    }\r\n\r\n    // -------------------- Hide Parent Money Fields (Stock User Only) --------------------\r\n    if (isStockUserOnly) {\r\n      const parentMoneyFields = [\r\n        \"currency\", \"conversion_rate\", \"price_list_currency\", \"plc_conversion_rate\",\r\n        \"base_total\", \"total\", \"base_net_total\", \"net_total\", \"base_grand_total\", \"grand_total\",\r\n        \"rounding_adjustment\", \"base_rounding_adjustment\", \"rounded_total\", \"base_rounded_total\",\r\n        \"in_words\", \"base_in_words\", \"disable_rounded_total\",\r\n        \"taxes\", \"taxes_and_charges\", \"taxes_and_charges_added\", \"taxes_and_charges_deducted\",\r\n        \"total_taxes_and_charges\", \"base_total_taxes_and_charges\", \"tax_category\",\r\n        \"apply_discount_on\", \"additional_discount_percentage\", \"discount_amount\",\r\n        \"additional_discount_amount\", \"base_discount_amount\", \"base_additional_discount_amount\",\r\n        \"payment_terms_template\", \"payment_schedule\", \"ignore_pricing_rule\", \"pricing_rules\",\r\n        \"cost_center\", \"project\", \"buying_price_list\", \"is_subcontracted\", \"rejected_warehouse\",\r\n        \"shipping_rule\", \"incoterm\", \"supplied_items\"\r\n      ];\r\n\r\n      parentMoneyFields.forEach((field) => {\r\n        frm.set_df_property(field, \"hidden\", 1);\r\n      });\r\n    }\r\n\r\n    // -------------------- Hide Items Grid Money Fields (Stock User Only) --------------------\r\n    if (isStockUserOnly && frm.fields_dict[\"items\"]?.grid) {\r\n      const grid = frm.fields_dict[\"items\"].grid;\r\n\r\n      const childMoneyFields = [\r\n        \"rate\", \"amount\", \"base_rate\", \"base_amount\", \"net_rate\", \"net_amount\",\r\n        \"price_list_rate\", \"valuation_rate\", \"discount_percentage\", \"discount_amount\",\r\n        \"item_tax_template\", \"item_tax_rate\", \"gross_profit\", \"margin_rate_or_amount\",\r\n        \"margin_type\", \"pricing_rules\", \"rm_supp_cost\", \"landed_cost_voucher_amount\"\r\n      ];\r\n\r\n      childMoneyFields.forEach((fieldname) => {\r\n        grid.update_docfield_property(fieldname, \"hidden\", 1);\r\n        grid.update_docfield_property(fieldname, \"read_only\", 1);\r\n      });\r\n\r\n      grid.refresh();\r\n    }\r\n\r\n    // -------------------- Block Add Row Button (ALL USERS) --------------------\r\n    // This enforces the PO-only workflow for all users\r\n    if (frm.fields_dict[\"items\"]?.grid) {\r\n      const grid = frm.fields_dict[\"items\"].grid;\r\n\r\n      // Disable adding rows\r\n      grid.cannot_add_rows = true;\r\n\r\n      // Hide the \"Add Row\" button from UI\r\n      if (grid.grid_buttons) {\r\n        grid.grid_buttons.find('.grid-add-row').hide();\r\n      }\r\n\r\n      // Hide row checkboxes (prevents deletion)\r\n      grid.grid_rows.forEach(row => {\r\n        if (row.wrapper) {\r\n          row.wrapper.find('.grid-row-check').hide();\r\n        }\r\n      });\r\n\r\n      grid.refresh();\r\n    }\r\n\r\n    // -------------------- Hide Dashboard Indicators (Stock User Only) --------------------\r\n    if (isStockUserOnly && frm.dashboard?.stats_area) {\r\n      setTimeout(() => {\r\n        frm.dashboard.stats_area.find(\".form-stats\").hide();\r\n      }, 200);\r\n    }\r\n  },\r\n\r\n  onload(frm) {\r\n    const isStockUserOnly =\r\n      frappe.user.has_role(\"Stock User\") &&\r\n      !frappe.user.has_role(\"System Manager\");\r\n\r\n    // -------------------- Hide Status Indicators on Load (Stock User Only) --------------------\r\n    if (isStockUserOnly) {\r\n      [\"status\", \"per_billed\"].forEach((field) => {\r\n        frm.set_df_property(field, \"hidden\", 1);\r\n      });\r\n    }\r\n\r\n    // -------------------- Block Add Row on Load (ALL USERS) --------------------\r\n    if (frm.fields_dict[\"items\"]?.grid) {\r\n      const grid = frm.fields_dict[\"items\"].grid;\r\n\r\n      // Disable adding rows\r\n      grid.cannot_add_rows = true;\r\n\r\n      // Hide the \"Add Row\" button\r\n      if (grid.grid_buttons) {\r\n        grid.grid_buttons.find('.grid-add-row').hide();\r\n      }\r\n    }\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.426079",
  "module": "Electro Zone",
  "name": "Sales Order - Discount Value Calculation",
  "script": "// Sales Order - Discount Value Calculation\r\n// Purpose: Lock rate field and auto-calculate amount = qty Ã— (rate - discount_value)\r\n// Pattern: Auto-Fill and Lock Fields on Selection (Pattern #4)\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// 1. FORM LOAD: Lock rate field on form render\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\nfrappe.ui.form.on(\"Sales Order\", {\r\n  refresh: function (frm) {\r\n    // Make rate field read-only in Sales Order Item grid\r\n    if (frm.fields_dict.items && frm.fields_dict.items.grid) {\r\n      frm.fields_dict.items.grid.update_docfield_property(\r\n        \"rate\",\r\n        \"read_only\",\r\n        1\r\n      );\r\n    }\r\n  },\r\n\r\n  onload: function (frm) {\r\n    // Also lock on initial load\r\n    if (frm.fields_dict.items && frm.fields_dict.items.grid) {\r\n      frm.fields_dict.items.grid.update_docfield_property(\r\n        \"rate\",\r\n        \"read_only\",\r\n        1\r\n      );\r\n    }\r\n  },\r\n});\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// 2. ITEM EVENTS: Auto-calculate amount when values change\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\nfrappe.ui.form.on(\"Sales Order Item\", {\r\n  // When new row added\r\n  items_add: function (frm, cdt, cdn) {\r\n    var item = locals[cdt][cdn];\r\n\r\n    // Set default discount_value to 0 if not set\r\n    if (!item.custom_discount_value) {\r\n      frappe.model.set_value(cdt, cdn, \"custom_discount_value\", 0);\r\n    }\r\n\r\n    // Calculate initial amount\r\n    calculate_amount(frm, cdt, cdn);\r\n  },\r\n\r\n  // When qty changes\r\n  qty: function (frm, cdt, cdn) {\r\n    calculate_amount(frm, cdt, cdn);\r\n  },\r\n\r\n  // When rate changes (via selection, not manual edit)\r\n  rate: function (frm, cdt, cdn) {\r\n    calculate_amount(frm, cdt, cdn);\r\n  },\r\n\r\n  // When discount_value changes\r\n  custom_discount_value: function (frm, cdt, cdn) {\r\n    calculate_amount(frm, cdt, cdn);\r\n  },\r\n\r\n  // When item_code is selected (rate auto-populated)\r\n  item_code: function (frm, cdt, cdn) {\r\n    // Wait for rate to be populated, then calculate\r\n    setTimeout(function () {\r\n      calculate_amount(frm, cdt, cdn);\r\n    }, 500);\r\n  },\r\n});\r\n\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// 3. HELPER FUNCTION: Calculate amount\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\nfunction calculate_amount(frm, cdt, cdn) {\r\n  var item = locals[cdt][cdn];\r\n\r\n  // Get values (default to 0 if null/undefined)\r\n  var qty = flt(item.qty) || 0;\r\n  var rate = flt(item.rate) || 0;\r\n  var discount_value = flt(item.custom_discount_value) || 0;\r\n\r\n  // Calculate: amount = qty Ã— (rate - discount_value)\r\n  var effective_rate = rate - discount_value;\r\n  var new_amount = qty * effective_rate;\r\n\r\n  // Update amount field\r\n  frappe.model.set_value(cdt, cdn, \"amount\", new_amount);\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Delivery Note",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.446838",
  "module": "Electro Zone",
  "name": "DN Return - State Buttons",
  "script": "// DN Return - State Buttons\r\n// Purpose: Add custom buttons for DN Return state transitions\r\n// Apply To: Delivery Note\r\n\r\nfrappe.ui.form.on(\"Delivery Note\", {\r\n  refresh: function (frm) {\r\n    // Hide \"Create\" button if DN Return status is \"Return Issued\"\r\n    // This prevents manual Credit Note creation until return is received\r\n    if (\r\n      frm.doc.is_return === 1 &&\r\n      frm.doc.custom_return_status === \"Return Issued\"\r\n    ) {\r\n      // Remove the \"Create\" menu to prevent Credit Note creation\r\n      setTimeout(function () {\r\n        frm.page.remove_inner_button(\"Sales Invoice\", \"Create\");\r\n        frm.page.remove_inner_button(\"Sales Return\", \"Create\");\r\n      }, 500);\r\n    }\r\n\r\n    // Only show custom buttons for DN Returns\r\n    if (frm.doc.is_return !== 1) {\r\n      return;\r\n    }\r\n\r\n    // Remove standard buttons for returns\r\n    frm.page.clear_primary_action();\r\n    frm.page.clear_secondary_action();\r\n\r\n    // Button 1: Issue Return (Draft to Return Issued)\r\n    if (frm.doc.docstatus === 0 && frm.doc.custom_return_status === \"Draft\") {\r\n      frm\r\n        .add_custom_button(__(\"Issue Return\"), function () {\r\n          // Save form first\r\n          frm.save().then(function () {\r\n            // Call API to issue return\r\n            frappe.call({\r\n              method: \"issue_dn_return\",\r\n              args: {\r\n                dn_return_name: frm.doc.name,\r\n              },\r\n              callback: function (r) {\r\n                if (r.message && r.message.success) {\r\n                  frappe.msgprint(r.message.message);\r\n                  frm.reload_doc();\r\n                } else {\r\n                  frappe.msgprint({\r\n                    title: __(\"Error\"),\r\n                    message: r.message\r\n                      ? r.message.message\r\n                      : \"Failed to issue return\",\r\n                    indicator: \"red\",\r\n                  });\r\n                }\r\n              },\r\n            });\r\n          });\r\n        })\r\n        .addClass(\"btn-primary\");\r\n    }\r\n\r\n    // Button 2: Receive Return (Return Issued to Return Received)\r\n    if (\r\n      frm.doc.docstatus === 1 &&\r\n      frm.doc.custom_return_status === \"Return Issued\"\r\n    ) {\r\n      frm\r\n        .add_custom_button(__(\"Receive Return\"), function () {\r\n          frappe.confirm(\r\n            \"This will create a Credit Note and update customer balance. Continue?\",\r\n            function () {\r\n              // Call API to receive return\r\n              frappe.call({\r\n                method: \"receive_dn_return\",\r\n                args: {\r\n                  dn_return_name: frm.doc.name,\r\n                },\r\n                callback: function (r) {\r\n                  if (r.message && r.message.success) {\r\n                    frappe.msgprint({\r\n                      title: __(\"Success\"),\r\n                      message: r.message.message,\r\n                      indicator: \"green\",\r\n                    });\r\n                    frm.reload_doc();\r\n                  } else {\r\n                    frappe.msgprint({\r\n                      title: __(\"Error\"),\r\n                      message: r.message\r\n                        ? r.message.message\r\n                        : \"Failed to receive return\",\r\n                      indicator: \"red\",\r\n                    });\r\n                  }\r\n                },\r\n              });\r\n            }\r\n          );\r\n        })\r\n        .addClass(\"btn-primary\");\r\n    }\r\n\r\n    // Disable form editing after Issue Return (soft submit lock)\r\n    if (frm.doc.docstatus === 1) {\r\n      frm.set_df_property(\"items\", \"read_only\", 1);\r\n      frm.disable_save();\r\n    }\r\n\r\n    // Show status indicator\r\n    if (frm.doc.custom_return_status) {\r\n      var color = \"grey\";\r\n      if (frm.doc.custom_return_status === \"Draft\") {\r\n        color = \"grey\";\r\n      } else if (frm.doc.custom_return_status === \"Return Issued\") {\r\n        color = \"orange\";\r\n      } else if (frm.doc.custom_return_status === \"Return Received\") {\r\n        color = \"green\";\r\n      }\r\n\r\n      frm.dashboard.add_indicator(\r\n        __(\"Return Status: \" + frm.doc.custom_return_status),\r\n        color\r\n      );\r\n    }\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Customer",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.449315",
  "module": "Electro Zone",
  "name": "Customer - Recalculate Balance Button ( Debug )",
  "script": "frappe.ui.form.on('Customer', {\r\n    refresh: function(frm) {\r\n        // Add custom button only if the form is saved (not new)\r\n        if (!frm.is_new()) {\r\n            frm.add_custom_button(__('Recalculate Balance'), function() {\r\n                frappe.call({\r\n                    method: \"recalculate_customer_balance\",\r\n                    args: {\r\n                        customer: frm.doc.name\r\n                    },\r\n                    freeze: true,\r\n                    freeze_message: __(\"Recalculating Customer Balance...\"),\r\n                    callback: function(r) {\r\n                        if (r.message) {\r\n                            // Display detailed success message\r\n                            let message = '';\r\n                            \r\n                            if (typeof r.message === 'object') {\r\n                                // If the response is an object, format it nicely\r\n                                message = '<div style=\"text-align: left;\">';\r\n                                \r\n                                for (let key in r.message) {\r\n                                    if (r.message.hasOwnProperty(key)) {\r\n                                        let label = key.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\r\n                                        let value = r.message[key];\r\n                                        \r\n                                        // Format numbers with commas if they are numeric\r\n                                        if (typeof value === 'number') {\r\n                                            value = value.toLocaleString('en-US', {\r\n                                                minimumFractionDigits: 2,\r\n                                                maximumFractionDigits: 2\r\n                                            });\r\n                                        }\r\n                                        \r\n                                        message += `<strong>${label}:</strong> ${value}<br>`;\r\n                                    }\r\n                                }\r\n                                message += '</div>';\r\n                            } else {\r\n                                // If it's a simple string message\r\n                                message = r.message;\r\n                            }\r\n                            \r\n                            frappe.msgprint({\r\n                                title: __('Balance Recalculated Successfully'),\r\n                                indicator: 'green',\r\n                                message: message\r\n                            });\r\n                            \r\n                            // Reload the document to show updated values\r\n                            frm.reload_doc();\r\n                        }\r\n                    },\r\n                    error: function(r) {\r\n                        frappe.msgprint({\r\n                            title: __('Error'),\r\n                            indicator: 'red',\r\n                            message: __('Failed to recalculate balance. Please check the console for details.')\r\n                        });\r\n                        console.error('Error details:', r);\r\n                    }\r\n                });\r\n            }).addClass('btn-primary');\r\n        }\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.417846",
  "module": "Electro Zone",
  "name": "Sales Order - Phone Number Lookup",
  "script": "// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n// SALES ORDER - PHONE NUMBER LOOKUP (PRODUCTION VERSION)\r\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\r\n\r\nfrappe.ui.form.on(\"Sales Order\", {\r\n  custom_customer_phone: function (frm) {\r\n    let phone = frm.doc.custom_customer_phone;\r\n\r\n    if (!phone || phone.trim() === \"\") {\r\n      return;\r\n    }\r\n\r\n    if (frm.doc.customer) {\r\n      frm.set_value(\"customer\", \"\");\r\n    }\r\n\r\n    let phone_clean = phone.replace(/[\\s\\-\\(\\)]/g, \"\");\r\n    const MIN_DIGITS = 11; // Configure: 10 or 11\r\n\r\n    if (phone_clean.length < MIN_DIGITS) {\r\n      frappe.show_alert(\r\n        {\r\n          message: __(\"Phone number too short. Enter at least {0} digits.\", [MIN_DIGITS]),\r\n          indicator: \"red\",\r\n        },\r\n        5\r\n      );\r\n      return;\r\n    }\r\n\r\n    frappe\r\n      .call({\r\n        method: \"get_customer_by_phone\",\r\n        args: {\r\n          phone_number: phone,\r\n        },\r\n      })\r\n      .then(({ message }) => {\r\n        if (!message) {\r\n          frappe.show_alert(\r\n            {\r\n              message: __(\"Search failed. Please try again.\"),\r\n              indicator: \"red\",\r\n            },\r\n            5\r\n          );\r\n          return;\r\n        }\r\n\r\n        if (message.success === false) {\r\n          frappe.show_alert(\r\n            {\r\n              message: __(\r\n                message.message || \"No customer found with this phone number\"\r\n              ),\r\n              indicator: \"orange\",\r\n            },\r\n            5\r\n          );\r\n          return;\r\n        }\r\n\r\n        if (message.count === 1) {\r\n          let customer = message.customers[0];\r\n          frm.set_value(\"customer\", customer.name);\r\n\r\n          let balance_info = \"\";\r\n          if (customer.custom_current_balance) {\r\n            balance_info = `<br><b>Balance:</b> ${format_currency(\r\n              customer.custom_current_balance\r\n            )}`;\r\n          }\r\n\r\n          frappe.show_alert(\r\n            {\r\n              message: __(\"Customer found: {0}{1}\", [\r\n                customer.customer_name,\r\n                balance_info,\r\n              ]),\r\n              indicator: \"green\",\r\n            },\r\n            5\r\n          );\r\n        } else if (message.count > 1) {\r\n          frappe.show_alert(\r\n            {\r\n              message: __(\r\n                \"Multiple customers found with phone: {0}. Please ensure unique phone numbers in Customer master.\",\r\n                [phone]\r\n              ),\r\n              indicator: \"red\",\r\n            },\r\n            8\r\n          );\r\n          frm.set_value(\"custom_customer_phone\", \"\");\r\n        } else {\r\n          frappe.show_alert(\r\n            {\r\n              message: __(\"No customer found with phone: {0}\", [phone]),\r\n              indicator: \"orange\",\r\n            },\r\n            5\r\n          );\r\n        }\r\n      })\r\n      .catch((error) => {\r\n        frappe.show_alert(\r\n          {\r\n            message: __(\"Search failed: {0}\", [\r\n              error.message || \"Unknown error\",\r\n            ]),\r\n            indicator: \"red\",\r\n          },\r\n          5\r\n        );\r\n        console.error(\"Phone lookup error:\", error);\r\n      });\r\n  },\r\n});\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.432018",
  "module": "Electro Zone",
  "name": "Purchase Order - Excel Download",
  "script": "frappe.ui.form.on('Purchase Order', {\r\n    refresh: function(frm) {\r\n        setTimeout(function() {\r\n            override_download_button(frm);\r\n        }, 500);\r\n    }\r\n});\r\n\r\nfunction override_download_button(frm) {\r\n    if (!frm.fields_dict.items || !frm.fields_dict.items.grid) return;\r\n    \r\n    let $download_btn = frm.fields_dict.items.grid.wrapper.find('.grid-download');\r\n    \r\n    if ($download_btn.length) {\r\n        $download_btn.off('click');\r\n        $download_btn.on('click', function(e) {\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n            download_items_as_excel(frm);\r\n        });\r\n    }\r\n}\r\n\r\nfunction download_items_as_excel(frm) {\r\n    let items = frm.doc.items || [];\r\n    \r\n    if (items.length === 0) {\r\n        return;\r\n    }\r\n    \r\n    if (typeof XLSX === 'undefined') {\r\n        let script = document.createElement('script');\r\n        script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';\r\n        script.onload = function() {\r\n            generate_and_download_excel(frm, items);\r\n        };\r\n        document.head.appendChild(script);\r\n    } else {\r\n        generate_and_download_excel(frm, items);\r\n    }\r\n}\r\n\r\nfunction generate_and_download_excel(frm, items) {\r\n    // Prepare data array\r\n    let data = [];\r\n    \r\n    // Headers\r\n    data.push([\r\n        'Item Code',\r\n        'Model Number',\r\n        'Description',\r\n        'Final Price List',\r\n        'Final Promo',\r\n        'Final Sellout Promo',\r\n        'Invoice Discount',\r\n        'Cash Discount',\r\n        'Qty',\r\n        'Rate'\r\n    ]);\r\n    \r\n    // Add rows\r\n    items.forEach(function(item) {\r\n        // Format percentages as text with %\r\n        let invoice_discount = item.custom_repeat_invoice_discount ? item.custom_repeat_invoice_discount.toFixed(2) + '%' : '0.00%';\r\n        let cash_discount = item.custom_repeat_cash_discount ? item.custom_repeat_cash_discount.toFixed(2) + '%' : '0.00%';\r\n        \r\n        data.push([\r\n            item.item_code || '',\r\n            item.custom_model_number || '',\r\n            item.description || '',\r\n            item.custom_final_price_list || 0,\r\n            item.custom_final_promo || 0,\r\n            item.custom_final_sellout_promo || 0,\r\n            invoice_discount,\r\n            cash_discount,\r\n            item.qty || '',\r\n            item.rate || 0\r\n        ]);\r\n    });\r\n    \r\n    // Create worksheet\r\n    let ws = XLSX.utils.aoa_to_sheet(data);\r\n    \r\n    // Set column widths\r\n    ws['!cols'] = [\r\n        {wch: 20},  // Item Code\r\n        {wch: 20},  // Model Number\r\n        {wch: 40},  // Description\r\n        {wch: 18},  // Final Price List\r\n        {wch: 15},  // Final Promo\r\n        {wch: 20},  // Final Sellout Promo\r\n        {wch: 18},  // Invoice Discount\r\n        {wch: 15},  // Cash Discount\r\n        {wch: 10},  // Qty\r\n        {wch: 15}   // Rate\r\n    ];\r\n    \r\n    // Apply formatting to cells\r\n    let range = XLSX.utils.decode_range(ws['!ref']);\r\n    \r\n    for (let R = range.s.r + 1; R <= range.e.r; ++R) {\r\n        // Column D (index 3): Final Price List - Number format with comma separator\r\n        let cell_d = XLSX.utils.encode_cell({r: R, c: 3});\r\n        if (!ws[cell_d]) ws[cell_d] = {t: 'n', v: 0};\r\n        ws[cell_d].z = '#,##0.00';\r\n        ws[cell_d].t = 'n';\r\n        \r\n        // Column E (index 4): Final Promo - Number format with comma separator\r\n        let cell_e = XLSX.utils.encode_cell({r: R, c: 4});\r\n        if (!ws[cell_e]) ws[cell_e] = {t: 'n', v: 0};\r\n        ws[cell_e].z = '#,##0.00';\r\n        ws[cell_e].t = 'n';\r\n        \r\n        // Column F (index 5): Final Sellout Promo - Number format with comma separator\r\n        let cell_f = XLSX.utils.encode_cell({r: R, c: 5});\r\n        if (!ws[cell_f]) ws[cell_f] = {t: 'n', v: 0};\r\n        ws[cell_f].z = '#,##0.00';\r\n        ws[cell_f].t = 'n';\r\n        \r\n        // Column G (index 6): Invoice Discount - Text format\r\n        let cell_g = XLSX.utils.encode_cell({r: R, c: 6});\r\n        if (ws[cell_g]) {\r\n            ws[cell_g].t = 's'; // Force as string/text\r\n        }\r\n        \r\n        // Column H (index 7): Cash Discount - Text format\r\n        let cell_h = XLSX.utils.encode_cell({r: R, c: 7});\r\n        if (ws[cell_h]) {\r\n            ws[cell_h].t = 's'; // Force as string/text\r\n        }\r\n        \r\n        // Column I (index 8): Qty - Text format\r\n        let cell_i = XLSX.utils.encode_cell({r: R, c: 8});\r\n        if (ws[cell_i]) {\r\n            ws[cell_i].t = 's'; // Force as string/text\r\n        }\r\n        \r\n        // Column J (index 9): Rate - Number format with comma separator\r\n        let cell_j = XLSX.utils.encode_cell({r: R, c: 9});\r\n        if (!ws[cell_j]) ws[cell_j] = {t: 'n', v: 0};\r\n        ws[cell_j].z = '#,##0.00';\r\n        ws[cell_j].t = 'n';\r\n    }\r\n    \r\n    // Create workbook\r\n    let wb = XLSX.utils.book_new();\r\n    XLSX.utils.book_append_sheet(wb, ws, 'Items');\r\n    \r\n    // Extract number from document name (e.g., PO-2024-00001 -> 00001)\r\n    let doc_name = frm.doc.name || '';\r\n    let parts = doc_name.split('-');\r\n    let number = parts.length > 0 ? parts[parts.length - 1] : '1';\r\n    \r\n    // Get current year\r\n    let year = new Date().getFullYear();\r\n    \r\n    // Generate filename: PUR-ORD-YYYY-NUM\r\n    let filename = 'PUR-ORD-' + year + '-' + number + '.xlsx';\r\n    \r\n    // Download\r\n    XLSX.writeFile(wb, filename);\r\n    \r\n    frappe.show_alert({\r\n        message: __('Excel file downloaded successfully'),\r\n        indicator: 'green'\r\n    }, 3);\r\n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.436138",
  "module": "Electro Zone",
  "name": "Purchase Order - Schedule Date ( Auto )",
  "script": "frappe.ui.form.on('Purchase Order Item', {\r\n    item_code: function(frm, cdt, cdn) {\r\n        let row = locals[cdt][cdn];\r\n        if (!row.schedule_date) {\r\n            // Set to 21 days from today\r\n            frappe.model.set_value(cdt, cdn, 'schedule_date', frappe.datetime.add_days(frappe.datetime.nowdate(), 21));\r\n        }\r\n    }\r\n});\r\n\r\nfrappe.ui.form.on('Purchase Order', {\r\n    before_save: function(frm) {\r\n        // Auto-fill schedule_date for all items before saving\r\n        frm.doc.items.forEach(function(item) {\r\n            if (!item.schedule_date) {\r\n                item.schedule_date = frappe.datetime.add_days(frappe.datetime.nowdate(), 21);\r\n            }\r\n        });\r\n    }\r\n});",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Purchase Order",
  "enabled": 1,
  "modified": "2026-01-01 01:14:47.434163",
  "module": "Electro Zone",
  "name": "Purchase Order - Hide Item Actions",
  "script": "// Run this globally to hide options whenever they appear\r\nsetInterval(function() {\r\n    $('ul[role=\"listbox\"]:visible div[role=\"option\"]').each(function() {\r\n        const title = $(this).find('p').attr('title');\r\n        const hasTextMuted = $(this).find('.text-muted').length > 0;\r\n        \r\n        if (title === 'Create a new Item' || title === 'Advanced Search' || title === '' || hasTextMuted) {\r\n            $(this).hide();\r\n        }\r\n    });\r\n}, 100);\r\n\r\nfrappe.ui.form.on('Purchase Order', {\r\n    refresh: function(frm) {\r\n        // Ensure it runs on form load\r\n        setTimeout(function() {\r\n            $('ul[role=\"listbox\"] div[role=\"option\"]').each(function() {\r\n                const title = $(this).find('p').attr('title');\r\n                const hasTextMuted = $(this).find('.text-muted').length > 0;\r\n                \r\n                if (title === 'Create a new Item' || title === 'Advanced Search' || title === '' || hasTextMuted) {\r\n                    $(this).hide();\r\n                }\r\n            });\r\n        }, 500);\r\n    }\r\n});",
  "view": "Form"
 }
]